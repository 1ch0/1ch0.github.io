

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="1ch0">
  <meta name="keywords" content="">
  <title>Python - 1ch0&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>1ch0's blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                联系我
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      1ch0
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-12-14 14:01" pubdate>
        2021年12月14日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      10.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      169
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">Python</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2 年前
                
              </p>
            
            <div class="markdown-body" id="post-body">
              <h2 id="项目创建"><a href="#项目创建" class="headerlink" title="项目创建"></a>项目创建</h2><pre><code class="hljs bash"><span class="hljs-comment"># 创建名为 django01的项目</span>
django-admin startproject django01 
<span class="hljs-comment"># 进入项目目录</span>
<span class="hljs-built_in">cd</span> django01 
<span class="hljs-comment"># 创建名为 app01的app</span>
django-admin startapp app01 
<span class="hljs-comment"># 启动django项目，默认127.0.0.1:8000</span>
python manage.py runserver 
<span class="hljs-comment"># 指定端口启动</span>
python manage.py runserver 8002  
<span class="hljs-comment"># 创建超级管理员</span>
python manage.py createsuperuser</code></pre>

<h2 id="Setting-py"><a href="#Setting-py" class="headerlink" title="Setting.py"></a>Setting.py</h2><p><strong>文档：</strong></p>
<p><a target="_blank" rel="noopener" href="https://docs.djangoproject.com/zh-hans/3.2/ref/settings/">https://docs.djangoproject.com/zh-hans/3.2/ref/settings/</a></p>
<h3 id="服务主机"><a href="#服务主机" class="headerlink" title="服务主机"></a>服务主机</h3><pre><code class="hljs python"><span class="hljs-comment"># 安全措施，允许哪些地址访问</span>
DEBUG = <span class="hljs-literal">True</span>  <span class="hljs-comment"># 生产环境要禁用</span>

ALLOWED_HOSTS = []  <span class="hljs-comment"># 默认。DEBUG=True时，根据[&#x27;.localhost&#x27;, &#x27;127.0.0.1&#x27;, &#x27;[::1]&#x27;]验证</span>
ALLOWED_HOSTS = [<span class="hljs-string">&#x27;*&#x27;</span>]  <span class="hljs-comment"># 允许所有</span>
ALLOWED_HOSTS = [<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-string">&#x27;192.168.1.10&#x27;</span>]  <span class="hljs-comment"># 允许指定ip访问</span></code></pre>

<h3 id="注册app"><a href="#注册app" class="headerlink" title="注册app"></a>注册app</h3><pre><code class="hljs python">INSTALLED_APPS = [
    ...
    <span class="hljs-string">&#x27;apps.app01.App01Config&#x27;</span>,  <span class="hljs-comment"># 新加</span>
    <span class="hljs-string">&#x27;apps.user.UserConfig&#x27;</span>  <span class="hljs-comment"># 新加</span>
]</code></pre>

<h3 id="Mysql数据库"><a href="#Mysql数据库" class="headerlink" title="Mysql数据库"></a>Mysql数据库</h3><pre><code class="hljs python">DATABASES = &#123;
    <span class="hljs-string">&#x27;default&#x27;</span>: &#123;
        <span class="hljs-string">&#x27;ENGINE&#x27;</span>: <span class="hljs-string">&#x27;django.db.backends.mysql&#x27;</span>,
        <span class="hljs-string">&#x27;NAME&#x27;</span>: <span class="hljs-string">&#x27;db_name&#x27;</span>,
        <span class="hljs-string">&#x27;USER&#x27;</span>: <span class="hljs-string">&#x27;root&#x27;</span>,
        <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;123456&#x27;</span>,
        <span class="hljs-string">&#x27;HOST&#x27;</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,
        <span class="hljs-string">&#x27;PORT&#x27;</span>: <span class="hljs-number">3306</span>
    &#125;,
    ...
&#125;</code></pre>

<h5 id="Pymysql"><a href="#Pymysql" class="headerlink" title="Pymysql"></a>Pymysql</h5><ul>
<li>推荐使用mysqlclient</li>
</ul>
<pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> pymysql</code></pre>

<p>settings.py 同级<code>__init__</code>.py </p>
<pre><code class="hljs elm"><span class="hljs-keyword">import</span> pymysql
<span class="hljs-title">pymysql</span>.install_as_MySQLdb()</code></pre>

<h5 id="Mysqlcilent"><a href="#Mysqlcilent" class="headerlink" title="Mysqlcilent"></a>Mysqlcilent</h5><pre><code class="hljs bash">pip install mysqlclient</code></pre>

<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> django-redis</code></pre>

<p>settings.py</p>
<pre><code class="hljs python">CACHES = &#123;
    <span class="hljs-comment"># 默认</span>
    <span class="hljs-string">&#x27;default&#x27;</span>: &#123;
        <span class="hljs-string">&#x27;BACKEND&#x27;</span>: <span class="hljs-string">&#x27;django.core.cache.backends.locmem.LocMemCache&#x27;</span>,
        <span class="hljs-string">&#x27;LOCATION&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>,
        <span class="hljs-string">&#x27;TIMEOUT&#x27;</span>: <span class="hljs-number">300</span>,  <span class="hljs-comment"># 缓存超时时间，单位秒。None：永久不过期</span>
        <span class="hljs-string">&#x27;OPTIONS&#x27;</span>: &#123;
            <span class="hljs-string">&#x27;MAX_ENTRIES&#x27;</span>: <span class="hljs-number">300</span>,  <span class="hljs-comment"># 允许缓存最大条目</span>
            <span class="hljs-string">&#x27;CULL_FREQUENCY&#x27;</span>: <span class="hljs-number">3</span>, <span class="hljs-comment"># 缓存条目最大时，删除条目的比例。1：全部；2：1/2；3：1/3</span>
            
        &#125;,
    &#125;,
    <span class="hljs-comment"># 附加缓存</span>
    <span class="hljs-string">&#x27;session&#x27;</span>: &#123;
        <span class="hljs-string">&#x27;BACKEND&#x27;</span>: <span class="hljs-string">&#x27;django_redis.cache.RedisCache&#x27;</span>,  <span class="hljs-comment"># 缓存redis</span>
        <span class="hljs-string">&#x27;LOCATION&#x27;</span>: <span class="hljs-string">&#x27;redis://127.0.0.1:6379/1&#x27;</span>,
        <span class="hljs-string">&#x27;OPTIONS&#x27;</span>: &#123;
            <span class="hljs-string">&#x27;CLIENT_CLASS&#x27;</span>: <span class="hljs-string">&#x27;django_redis.client.DefaultClient&#x27;</span>,
            <span class="hljs-comment"># &#x27;PASSWORD&#x27;: &#x27;&#x27;</span>
        &#125;
    &#125;,
    <span class="hljs-comment"># 购物车</span>
    <span class="hljs-string">&#x27;cart&#x27;</span>: &#123;
        <span class="hljs-string">&#x27;BACKEND&#x27;</span>: <span class="hljs-string">&#x27;django_redis.cache.RedisCache&#x27;</span>,  <span class="hljs-comment"># 缓存redis</span>
        <span class="hljs-string">&#x27;LOCATION&#x27;</span>: <span class="hljs-string">&#x27;redis://127.0.0.1:6379/2&#x27;</span>,
        <span class="hljs-string">&#x27;OPTIONS&#x27;</span>: &#123;
            <span class="hljs-string">&#x27;CLIENT_CLASS&#x27;</span>: <span class="hljs-string">&#x27;django_redis.client.DefaultClient&#x27;</span>,
            <span class="hljs-comment"># &#x27;PASSWORD&#x27;: &#x27;&#x27;</span>
        &#125;
    &#125;,
&#125;</code></pre>

<p>views.py</p>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> django_redis <span class="hljs-keyword">import</span> get_redis_connection
 
conn = get_redis_connection(<span class="hljs-string">&#x27;cart&#x27;</span>)
print(conn.hgetall(<span class="hljs-string">&#x27;xxx&#x27;</span>))</code></pre>

<h3 id="HTML模板目录"><a href="#HTML模板目录" class="headerlink" title="HTML模板目录"></a>HTML模板目录</h3><pre><code class="hljs python">TEMPLATES = [
    &#123;
        <span class="hljs-string">&#x27;BACKEND&#x27;</span>: <span class="hljs-string">&#x27;django.template.backends.django.DjangoTemplates&#x27;</span>,
        <span class="hljs-string">&#x27;DIRS&#x27;</span>: [os.path.join(BASE_DIR, <span class="hljs-string">&#x27;templates&#x27;</span>)]   <span class="hljs-comment"># 指定html文件所在的位置目录templates</span>
        ,
        <span class="hljs-string">&#x27;APP_DIRS&#x27;</span>: <span class="hljs-literal">True</span>,
        <span class="hljs-string">&#x27;OPTIONS&#x27;</span>: &#123;
            <span class="hljs-string">&#x27;context_processors&#x27;</span>: [
                <span class="hljs-string">&#x27;django.template.context_processors.debug&#x27;</span>,
                <span class="hljs-string">&#x27;django.template.context_processors.request&#x27;</span>,
                <span class="hljs-string">&#x27;django.contrib.auth.context_processors.auth&#x27;</span>,
                <span class="hljs-string">&#x27;django.contrib.messages.context_processors.messages&#x27;</span>,
            ],
        &#125;,
    &#125;,
]</code></pre>

<h3 id="语言时区"><a href="#语言时区" class="headerlink" title="语言时区"></a>语言时区</h3><pre><code class="hljs python">LANGUAGE_CODE = <span class="hljs-string">&#x27;zh-hans&#x27;</span>  <span class="hljs-comment"># 中文显示</span>
TIME_ZONE = <span class="hljs-string">&#x27;Asia/Shanghai&#x27;</span>  <span class="hljs-comment"># 设置时区</span>
USE_I18N = <span class="hljs-literal">True</span>  <span class="hljs-comment"># 国际化</span>
USE_L10N = <span class="hljs-literal">True</span>  <span class="hljs-comment"># admin后台显示时间格式化为 &#x27;2020-09-12 12:00:00&#x27;</span>
USE_TZ = <span class="hljs-literal">False</span>  <span class="hljs-comment"># ORM查询返回，是否自动转换为UTC时间</span></code></pre>

<h3 id="静态文件"><a href="#静态文件" class="headerlink" title="静态文件"></a>静态文件</h3><pre><code class="hljs python"><span class="hljs-comment"># 静态文件夹的别名</span>
STATIC_URL = <span class="hljs-string">&#x27;/static/&#x27;</span>
<span class="hljs-comment"># 所有静态文件（css/js/图片）都放在我下面你配置的文件夹中</span>
STATICFILES_DIRS = [
    os.path.join(BASE_DIR, <span class="hljs-string">&quot;static&quot;</span>),
]</code></pre>

<h3 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h3><pre><code class="hljs python"><span class="hljs-comment"># 数据库Session（默认）</span>
SESSION_ENGINE = <span class="hljs-string">&#x27;django.contrib.sessions.backends.db&#x27;</span>   <span class="hljs-comment"># 存储数据库</span>

<span class="hljs-comment"># 缓存Session</span>
SESSION_ENGINE = <span class="hljs-string">&#x27;django.contrib.sessions.backends.cache&#x27;</span>  <span class="hljs-comment"># 指定缓存存储</span>
SESSION_CACHE_ALIAS = <span class="hljs-string">&#x27;default&#x27;</span>                            <span class="hljs-comment"># 使用的缓存别名（默认内存缓存，也可以是memcache），此处别名依赖缓存的设置</span>
 
<span class="hljs-comment"># 文件Session</span>
SESSION_ENGINE = <span class="hljs-string">&#x27;django.contrib.sessions.backends.file&#x27;</span>    <span class="hljs-comment"># 存储文件</span>
SESSION_FILE_PATH = <span class="hljs-literal">None</span>                                    <span class="hljs-comment"># 缓存文件路径，如果为None，则使用tempfile模块获取一个临时地址tempfile.gettempdir() </span>
 
<span class="hljs-comment"># 缓存+数据库</span>
SESSION_ENGINE = <span class="hljs-string">&#x27;django.contrib.sessions.backends.cached_db&#x27;</span>        <span class="hljs-comment"># 引擎</span>
 
<span class="hljs-comment"># 加密Cookie Session</span>
SESSION_ENGINE = <span class="hljs-string">&#x27;django.contrib.sessions.backends.signed_cookies&#x27;</span>   <span class="hljs-comment"># 引擎</span>
 
<span class="hljs-comment"># 其他公用设置项：</span>
SESSION_COOKIE_NAME ＝ <span class="hljs-string">&quot;sessionid&quot;</span>            <span class="hljs-comment"># Session的cookie保存在浏览器上时的key，即：sessionid＝随机字符串（默认）</span>
SESSION_COOKIE_PATH ＝ <span class="hljs-string">&quot;/&quot;</span>                    <span class="hljs-comment"># Session的cookie保存的路径。默认 /</span>
SESSION_COOKIE_DOMAIN = <span class="hljs-literal">None</span>                  <span class="hljs-comment"># Session的cookie保存的域名。默认 None</span>
SESSION_COOKIE_SECURE = <span class="hljs-literal">False</span>                 <span class="hljs-comment"># 是否Https传输cookie。默认 False</span>
SESSION_COOKIE_HTTPONLY = <span class="hljs-literal">True</span>                <span class="hljs-comment"># 是否Session的cookie只支持http传输。默认 True</span>
SESSION_COOKIE_AGE = <span class="hljs-number">1209600</span>                  <span class="hljs-comment"># session的cookie失效日期，单位秒，默认2周</span>
SESSION_EXPIRE_AT_BROWSER_CLOSE = <span class="hljs-literal">False</span>       <span class="hljs-comment"># 是否关闭浏览器使得Session过期。默认</span>
SESSION_SAVE_EVERY_REQUEST = <span class="hljs-literal">False</span>            <span class="hljs-comment"># 是否每次请求都保存Session，默认修改之后才保存。默认</span></code></pre>

<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><pre><code class="hljs python">LOGGING = &#123;
    <span class="hljs-string">&#x27;version&#x27;</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">&#x27;disable_existing_loggers&#x27;</span>: <span class="hljs-literal">False</span>,
    <span class="hljs-string">&#x27;formatters&#x27;</span>: &#123;
        <span class="hljs-string">&#x27;verbose&#x27;</span>: &#123;
            <span class="hljs-string">&#x27;format&#x27;</span>: <span class="hljs-string">&#x27;&#123;levelname&#125; &#123;asctime&#125; &#123;module&#125; &#123;message&#125; &#x27;</span>,
            <span class="hljs-string">&#x27;style&#x27;</span>: <span class="hljs-string">&#x27;&#123;&#x27;</span>,
        &#125;,
        <span class="hljs-string">&#x27;simple&#x27;</span>: &#123;
            <span class="hljs-string">&#x27;format&#x27;</span>: <span class="hljs-string">&#x27;&#123;levelname&#125; &#123;message&#125;&#x27;</span>,
            <span class="hljs-string">&#x27;style&#x27;</span>: <span class="hljs-string">&#x27;&#123;&#x27;</span>,
        &#125;,
    &#125;,
    <span class="hljs-string">&#x27;handlers&#x27;</span>: &#123;
        <span class="hljs-string">&#x27;sql&#x27;</span>: &#123;
            <span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;DEBUG&#x27;</span>,
            <span class="hljs-string">&#x27;class&#x27;</span>: <span class="hljs-string">&#x27;logging.FileHandler&#x27;</span>,
            <span class="hljs-string">&#x27;filename&#x27;</span>: os.path.join(BASE_DIR, <span class="hljs-string">&quot;logs/sql.log&quot;</span>),
            <span class="hljs-string">&#x27;formatter&#x27;</span>: <span class="hljs-string">&#x27;verbose&#x27;</span>
        &#125;,
        <span class="hljs-string">&#x27;error&#x27;</span>: &#123;
            <span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;INFO&#x27;</span>,
            <span class="hljs-string">&#x27;class&#x27;</span>: <span class="hljs-string">&#x27;logging.FileHandler&#x27;</span>,
            <span class="hljs-string">&#x27;filename&#x27;</span>: os.path.join(BASE_DIR, <span class="hljs-string">&quot;logs/error.log&quot;</span>),
            <span class="hljs-string">&#x27;formatter&#x27;</span>: <span class="hljs-string">&#x27;verbose&#x27;</span>
        &#125;,
    &#125;,
    <span class="hljs-string">&#x27;loggers&#x27;</span>: &#123;
        <span class="hljs-string">&#x27;django&#x27;</span>: &#123;
            <span class="hljs-string">&#x27;handlers&#x27;</span>: [<span class="hljs-string">&#x27;error&#x27;</span>],
            <span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;DEBUG&#x27;</span>,
            <span class="hljs-string">&#x27;propagate&#x27;</span>: <span class="hljs-literal">True</span>,
        &#125;,
        <span class="hljs-string">&#x27;error&#x27;</span>: &#123;
            <span class="hljs-string">&#x27;handlers&#x27;</span>: [<span class="hljs-string">&#x27;error&#x27;</span>],
            <span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;DEBUG&#x27;</span>,
            <span class="hljs-string">&#x27;propagate&#x27;</span>: <span class="hljs-literal">True</span>,
        &#125;,
        <span class="hljs-string">&#x27;django.db.backends&#x27;</span>: &#123;
            <span class="hljs-string">&#x27;handlers&#x27;</span>: [<span class="hljs-string">&#x27;sql&#x27;</span>],
            <span class="hljs-string">&#x27;level&#x27;</span>: <span class="hljs-string">&#x27;DEBUG&#x27;</span>,
            <span class="hljs-string">&#x27;propagate&#x27;</span>: <span class="hljs-literal">True</span>,
        &#125;,
    &#125;,
&#125;</code></pre>

<h2 id="Simpleui-后台"><a href="#Simpleui-后台" class="headerlink" title="Simpleui 后台"></a>Simpleui 后台</h2><p>官网教程：<a target="_blank" rel="noopener" href="https://simpleui.72wo.com/docs/simpleui/doc.html">https://simpleui.72wo.com/docs/simpleui/doc.html</a></p>
<pre><code class="hljs sh">pip install django-simpleui</code></pre>

<p>settings.py 加入</p>
<pre><code class="hljs python">INSTALLED_APPS = [
    <span class="hljs-string">&#x27;simpleui&#x27;</span>,
    ...
]</code></pre>

<h2 id="环境打包"><a href="#环境打包" class="headerlink" title="环境打包"></a>环境打包</h2><pre><code class="hljs bash"><span class="hljs-comment"># 打包环境</span>
pip freeze &gt; requirements.txt
<span class="hljs-comment"># 下载环境</span>
pip install -r requirements.txt</code></pre>

<h2 id="Model-模型"><a href="#Model-模型" class="headerlink" title="Model 模型"></a>Model 模型</h2><ul>
<li>文档：<a target="_blank" rel="noopener" href="https://docs.djangoproject.com/zh-hans/3.2/ref/models/fields/">https://docs.djangoproject.com/zh-hans/3.2/ref/models/fields/</a></li>
</ul>
<pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Author</span>(<span class="hljs-params">models.Model</span>):</span>
    GENDERS = (
        (<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;男&#x27;</span>),
        (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;女&#x27;</span>)
    )
    name = models.CharField(max_length=<span class="hljs-number">20</span>, verbose_name=<span class="hljs-string">&#x27;名字&#x27;</span>, db_column=<span class="hljs-string">&#x27;name&#x27;</span>)
    gender = models.IntegerField(default=<span class="hljs-number">0</span>, choices=GENDERS, verbose_name=<span class="hljs-string">&#x27;性别&#x27;</span>)
    created = models.DateTimeField(auto_now_add=<span class="hljs-literal">True</span>, verbose_name=<span class="hljs-string">&#x27;创建时间&#x27;</span>)
    updated = models.DateTimeField(auto_now=<span class="hljs-literal">True</span>, verbose_name=<span class="hljs-string">&#x27;更新时间&#x27;</span>)
    deleted = models.IntegerField(default=<span class="hljs-number">0</span>, verbose_name=<span class="hljs-string">&#x27;逻辑删除&#x27;</span>)

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        <span class="hljs-comment"># managed = False</span>
        db_table = <span class="hljs-string">&#x27;author&#x27;</span>
        app_label = <span class="hljs-string">&#x27;demo&#x27;</span>

    <span class="hljs-comment"># 逻辑删除</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span>(<span class="hljs-params">self, using=<span class="hljs-literal">None</span>, keep_parents=<span class="hljs-literal">False</span></span>):</span>
        self.deleted = <span class="hljs-number">1</span>
        self.save()
        
        
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Book</span>(<span class="hljs-params">models.Model</span>):</span>
    name = models.CharField(max_length=<span class="hljs-number">30</span>, default=<span class="hljs-string">&#x27;&#x27;</span>, verbose_name=<span class="hljs-string">&#x27;书名&#x27;</span>)
    author = models.ForeignKey(Author, on_delete=models.CASCADE, db_constraint=<span class="hljs-literal">False</span>, related_name=<span class="hljs-string">&#x27;作者&#x27;</span>)  <span class="hljs-comment"># db_constraint=False：逻辑外键。数据库不使用外键，仅django内部使用</span>
    price = models.IntegerField(default=<span class="hljs-number">0</span>, verbose_name=<span class="hljs-string">&#x27;价格&#x27;</span>)
    seq = models.IntegerField(default=<span class="hljs-number">0</span>, verbose_name=<span class="hljs-string">&#x27;顺序&#x27;</span>)
    created = models.DateTimeField(auto_now_add=<span class="hljs-literal">True</span>, verbose_name=<span class="hljs-string">&#x27;创建时间&#x27;</span>)
    updated = models.DateTimeField(auto_now=<span class="hljs-literal">True</span>, verbose_name=<span class="hljs-string">&#x27;更新时间&#x27;</span>)
    deleted = models.IntegerField(default=<span class="hljs-number">0</span>, verbose_name=<span class="hljs-string">&#x27;逻辑删除&#x27;</span>)

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        <span class="hljs-comment"># managed = False</span>
        db_table = <span class="hljs-string">&#x27;book&#x27;</span>
        app_label = <span class="hljs-string">&#x27;demo&#x27;</span></code></pre>

<h4 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h4><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
    <span class="hljs-comment"># 索引</span>
    indexes = [
        models.Index(fields=[<span class="hljs-string">&#x27;project&#x27;</span>]),
    ]
        
    <span class="hljs-comment"># 联合索引</span>
    index_together = [[<span class="hljs-string">&quot;pub_date&quot;</span>, <span class="hljs-string">&quot;deadline&quot;</span>]]
	<span class="hljs-comment"># index_together = [&quot;pub_date&quot;, &quot;deadline&quot;]  # 单字段可以一个列表 </span>

    <span class="hljs-comment"># 联合唯一索引</span>
    unique_together = [[<span class="hljs-string">&#x27;driver&#x27;</span>, <span class="hljs-string">&#x27;restaurant&#x27;</span>]]  
    <span class="hljs-comment"># unique_together = [&#x27;driver&#x27;, &#x27;restaurant&#x27;]</span></code></pre>

<h4 id="DateTimeField"><a href="#DateTimeField" class="headerlink" title="DateTimeField"></a>DateTimeField</h4><p>精度默认为 6，修改为0 需要将相对配置 datetime(6) 改为 datetime</p>
<pre><code class="hljs python"><span class="hljs-comment">## settings.py</span>
<span class="hljs-keyword">from</span> django.db.backends.mysql.base <span class="hljs-keyword">import</span> DatabaseWrapper
DatabaseWrapper.data_types[<span class="hljs-string">&#x27;DateTimeField&#x27;</span>] = <span class="hljs-string">&#x27;datetime&#x27;</span></code></pre>

<h4 id="模型逆向生成"><a href="#模型逆向生成" class="headerlink" title="模型逆向生成"></a>模型逆向生成</h4><pre><code class="hljs python">python manage.py inspectdb &gt; apps/models.py
<span class="hljs-comment"># 指定表生成</span>
python manage.py inspectdb tb &gt; apps/models.py</code></pre>

<h4 id="清理migrations"><a href="#清理migrations" class="headerlink" title="清理migrations"></a>清理migrations</h4><pre><code class="hljs python">python manage.py makemigrations	<span class="hljs-comment"># 确保 migration文件和数据库同步</span>
python manage.py showmigrations	<span class="hljs-comment"># 看文件是否都迁移成功。[X]表示迁移成功</span>
python manage.py migrate --fake app名 zero  <span class="hljs-comment"># 清除迁移历史记录</span>
python manage.py makemigrations  <span class="hljs-comment"># 再次生成迁移文件</span>
python manage.py migrate --fake-initial  <span class="hljs-comment"># 执行迁移，但不会真的执行</span></code></pre>



<h2 id="多数据库"><a href="#多数据库" class="headerlink" title="多数据库"></a>多数据库</h2><p><strong>settings.py</strong></p>
<pre><code class="hljs python">DATABASES = &#123;
    <span class="hljs-string">&#x27;default&#x27;</span>: &#123;
        <span class="hljs-string">&#x27;ENGINE&#x27;</span>: <span class="hljs-string">&#x27;django.db.backends.mysql&#x27;</span>,
        <span class="hljs-string">&#x27;NAME&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>,
        <span class="hljs-string">&#x27;USER&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>,
        <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>,
        <span class="hljs-string">&#x27;HOST&#x27;</span>: <span class="hljs-string">&#x27;localhost&#x27;</span>,
        <span class="hljs-string">&#x27;PORT&#x27;</span>: <span class="hljs-number">3306</span>
    &#125;,
    <span class="hljs-string">&#x27;db02&#x27;</span>: &#123;
        <span class="hljs-string">&#x27;ENGINE&#x27;</span>: <span class="hljs-string">&#x27;django.db.backends.mysql&#x27;</span>,
        <span class="hljs-string">&#x27;NAME&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>,
        <span class="hljs-string">&#x27;USER&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>,
        <span class="hljs-string">&#x27;PASSWORD&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>,
        <span class="hljs-string">&#x27;HOST&#x27;</span>: <span class="hljs-string">&#x27;localhost&#x27;</span>,
        <span class="hljs-string">&#x27;PORT&#x27;</span>: <span class="hljs-number">3306</span>
    &#125;
&#125;
<span class="hljs-comment"># 数据库路由文件地址</span>
DATABASE_ROUTERS = [<span class="hljs-string">&#x27;fresh.database_router.DatabaseAppsRouter&#x27;</span>]
<span class="hljs-comment"># 配置app对应的路由表</span>
DATABASE_APPS_MAPPING = &#123;
    <span class="hljs-string">&#x27;app01&#x27;</span>: <span class="hljs-string">&#x27;default&#x27;</span>,
    <span class="hljs-string">&#x27;app02&#x27;</span>: <span class="hljs-string">&#x27;db02&#x27;</span>,
    <span class="hljs-string">&#x27;app03&#x27;</span>: <span class="hljs-string">&#x27;db02&#x27;</span>,
&#125;</code></pre>

<p><strong>创建数据库路由规则</strong></p>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> django.conf <span class="hljs-keyword">import</span> settings

DATABASE_MAPPING = settings.DATABASE_APPS_MAPPING


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseAppsRouter</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot;</span>
<span class="hljs-string">    A router to control all database operations on models for different</span>
<span class="hljs-string">    databases.</span>
<span class="hljs-string">    In case an app is not set in settings.DATABASE_APPS_MAPPING, the router</span>
<span class="hljs-string">    will fallback to the `default` database.</span>
<span class="hljs-string">    Settings example:</span>
<span class="hljs-string">    DATABASE_APPS_MAPPING = &#123;&#x27;app1&#x27;: &#x27;db1&#x27;, &#x27;app2&#x27;: &#x27;db2&#x27;&#125;</span>
<span class="hljs-string">    &quot;&quot;&quot;</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">db_for_read</span>(<span class="hljs-params">self, model, **hints</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;&quot;Point all read operations to the specific database.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">if</span> model._meta.app_label <span class="hljs-keyword">in</span> DATABASE_MAPPING:
            <span class="hljs-keyword">return</span> DATABASE_MAPPING[model._meta.app_label]
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">db_for_write</span>(<span class="hljs-params">self, model, **hints</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;Point all write operations to the specific database.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">if</span> model._meta.app_label <span class="hljs-keyword">in</span> DATABASE_MAPPING:
            <span class="hljs-keyword">return</span> DATABASE_MAPPING[model._meta.app_label]
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">allow_relation</span>(<span class="hljs-params">self, obj1, obj2, **hints</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;Allow any relation between apps that use the same database.&quot;&quot;&quot;</span>
        db_obj1 = DATABASE_MAPPING.get(obj1._meta.app_label)
        db_obj2 = DATABASE_MAPPING.get(obj2._meta.app_label)
        <span class="hljs-keyword">if</span> db_obj1 <span class="hljs-keyword">and</span> db_obj2:
            <span class="hljs-keyword">if</span> db_obj1 == db_obj2:
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">allow_syncdb</span>(<span class="hljs-params">self, db, model</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;Make sure that apps only appear in the related database.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">if</span> db <span class="hljs-keyword">in</span> DATABASE_MAPPING.values():
            <span class="hljs-keyword">return</span> DATABASE_MAPPING.get(model._meta.app_label) == db
        <span class="hljs-keyword">elif</span> model._meta.app_label <span class="hljs-keyword">in</span> DATABASE_MAPPING:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">allow_migrate</span>(<span class="hljs-params">self, db, app_label, model=<span class="hljs-literal">None</span>, **hints</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;</span>
<span class="hljs-string">        Make sure the auth app only appears in the &#x27;auth_db&#x27;</span>
<span class="hljs-string">        database.</span>
<span class="hljs-string">        &quot;&quot;&quot;</span>
        <span class="hljs-keyword">if</span> db <span class="hljs-keyword">in</span> DATABASE_MAPPING.values():
            <span class="hljs-keyword">return</span> DATABASE_MAPPING.get(app_label) == db
        <span class="hljs-keyword">elif</span> app_label <span class="hljs-keyword">in</span> DATABASE_MAPPING:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span></code></pre>

<p><strong>创建model</strong></p>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> models


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Author</span>(<span class="hljs-params">models.Model</span>):</span>
    name = models.CharField(max_length=<span class="hljs-number">20</span>)
    created = models.DateTimeField()
    updated = models.DateTimeField()
    deleted = models.IntegerField()

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        db_table = <span class="hljs-string">&#x27;author&#x27;</span>
        app_label = <span class="hljs-string">&#x27;demo&#x27;</span></code></pre>

<p><strong>生成数据表</strong></p>
<pre><code class="hljs python">python manage.py makemigrations
python manage.py migrate --database=db02</code></pre>

<h2 id="跨域解决"><a href="#跨域解决" class="headerlink" title="跨域解决"></a>跨域解决</h2><h4 id="方案一：禁用跨域校验（开发模式可以用）"><a href="#方案一：禁用跨域校验（开发模式可以用）" class="headerlink" title="方案一：禁用跨域校验（开发模式可以用）"></a>方案一：禁用跨域校验（开发模式可以用）</h4><pre><code class="hljs python">MIDDLEWARE = [
    <span class="hljs-comment"># &#x27;django.middleware.csrf.CsrfViewMiddleware&#x27;,  # 注释这行，会允许所有跨域请求</span>
]</code></pre>

<h4 id="方案二：cors扩展（推荐）"><a href="#方案二：cors扩展（推荐）" class="headerlink" title="方案二：cors扩展（推荐）"></a>方案二：cors扩展（推荐）</h4><pre><code class="hljs sh">pip install django-cors-headers</code></pre>

<p><strong>setting.py</strong></p>
<pre><code class="hljs python"><span class="hljs-comment"># 配置应用</span>
INSTALLED_APPS = [
    ...
    <span class="hljs-string">&#x27;corsheaders&#x27;</span>,
    ...
]
<span class="hljs-comment"># 中间层设置</span>
MIDDLEWARE = [
    <span class="hljs-string">&#x27;corsheaders.middleware.CorsMiddleware&#x27;</span>,  <span class="hljs-comment"># 注意顺序放首位</span>
    ...
]
CORS_ALLOW_CREDENTIALS = <span class="hljs-literal">True</span> <span class="hljs-comment"># 允许携带cookie</span>
<span class="hljs-comment"># CORS_ORIGIN_ALLOW_ALL = True # 允许所有主机跨域</span>
<span class="hljs-comment"># 允许跨域白名单</span>
CORS_ORIGIN_WHITELIST = (
    <span class="hljs-string">&#x27;127.0.0.1:8080&#x27;</span>,
    ...
)
<span class="hljs-comment"># 允许跨域请求方法</span>
CORS_ALLOW_METHODS = (
    <span class="hljs-string">&#x27;GET&#x27;</span>,
    <span class="hljs-string">&#x27;POST&#x27;</span>,
    <span class="hljs-string">&#x27;PUT&#x27;</span>,
    <span class="hljs-string">&#x27;PATCH&#x27;</span>,
    <span class="hljs-string">&#x27;DELETE&#x27;</span>,
    <span class="hljs-string">&#x27;OPTIONS&#x27;</span>,
    <span class="hljs-string">&#x27;VIEW&#x27;</span>,
)
<span class="hljs-comment"># 允许跨域请求头</span>
CORS_ALLOW_HEADERS = (
    <span class="hljs-string">&#x27;XMLHttpRequest&#x27;</span>,
    <span class="hljs-string">&#x27;X_FILENAME&#x27;</span>,
    <span class="hljs-string">&#x27;accept-encoding&#x27;</span>,
    <span class="hljs-string">&#x27;authorization&#x27;</span>,
    <span class="hljs-string">&#x27;content-type&#x27;</span>,
    <span class="hljs-string">&#x27;dnt&#x27;</span>,
    <span class="hljs-string">&#x27;origin&#x27;</span>,
    <span class="hljs-string">&#x27;user-agent&#x27;</span>,
    <span class="hljs-string">&#x27;x-csrftoken&#x27;</span>,
    <span class="hljs-string">&#x27;x-requested-with&#x27;</span>,
    <span class="hljs-string">&#x27;Pragma&#x27;</span>,
)</code></pre>

<h2 id="Session-会话"><a href="#Session-会话" class="headerlink" title="Session 会话"></a>Session 会话</h2><p><strong>全局配置</strong></p>
<pre><code class="hljs python"><span class="hljs-comment"># setting.py</span>

<span class="hljs-comment"># 缓存session</span>
CACHES = &#123;
    ...
    <span class="hljs-string">&#x27;session&#x27;</span>: &#123;
        <span class="hljs-string">&#x27;BACKEND&#x27;</span>: <span class="hljs-string">&#x27;django_redis.cache.RedisCache&#x27;</span>,
        <span class="hljs-string">&#x27;LOCATION&#x27;</span>: <span class="hljs-string">&#x27;redis://127.0.0.1:6379/1&#x27;</span>,
        <span class="hljs-string">&#x27;OPTIONS&#x27;</span>: &#123;
            <span class="hljs-string">&#x27;CLIENT_CLASS&#x27;</span>: <span class="hljs-string">&#x27;django_redis.client.DefaultClient&#x27;</span>,
            <span class="hljs-comment"># &#x27;PASSWORD&#x27;: &#x27;&#x27;</span>
        &#125;
    &#125;
&#125;

<span class="hljs-comment"># Session配置</span>
SESSION_ENGINE = <span class="hljs-string">&#x27;django.contrib.sessions.backends.cache&#x27;</span>  <span class="hljs-comment"># 指定redis存储</span>
SESSION_CACHE_ALIAS = <span class="hljs-string">&#x27;session&#x27;</span>  <span class="hljs-comment"># 使用的缓存别名</span>
SESSION_COOKIE_AGE = <span class="hljs-number">30</span>  <span class="hljs-comment"># 过期时间，单位秒。默认2周</span>

REST_FRAMEWORK = &#123;
    <span class="hljs-comment"># 自定义认证</span>
    <span class="hljs-string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: (
        <span class="hljs-string">&#x27;utils.custom_authentication.CustomJWTAuth&#x27;</span>,
    ),
&#125;</code></pre>

<h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><pre><code class="hljs python">request.session.session_key  <span class="hljs-comment"># 获取sessionid</span>
request.session.exists(<span class="hljs-string">&#x27;sessionid&#x27;</span>)  <span class="hljs-comment"># 判断获取sessionid是否存在</span>

request.session[<span class="hljs-string">&#x27;key&#x27;</span>] = <span class="hljs-string">&#x27;value&#x27;</span>  <span class="hljs-comment"># 设置session</span>
request.session.setdefault(<span class="hljs-string">&#x27;key&#x27;</span>, <span class="hljs-string">&#x27;value&#x27;</span>)  <span class="hljs-comment"># 不存在则设置</span>
request.session.get(<span class="hljs-string">&#x27;key&#x27;</span>)  <span class="hljs-comment"># 获取session，默认None</span>
<span class="hljs-keyword">del</span> request.session[<span class="hljs-string">&#x27;key&#x27;</span>]  <span class="hljs-comment"># 删除session指定键值对</span>
request.session.delete()  <span class="hljs-comment"># 删除当前会话数据和数据库数据</span>
request.session.clear()  <span class="hljs-comment"># 清除session，删除存储session值</span>
request.session.flush()  <span class="hljs-comment"># 清除session，删除当前会话cookie和存储session（常用）</span>

request.session.keys()  <span class="hljs-comment"># 获取所有键</span>
request.session.values()  <span class="hljs-comment"># 获取所有值</span>
request.session.items()  <span class="hljs-comment"># 获取所有键值对</span>
request.session.iterkeys()  <span class="hljs-comment"># </span>
request.session.itervalues()  <span class="hljs-comment">#</span>
request.session.iteritems()  <span class="hljs-comment"># </span>

request.session.clear_expired()  <span class="hljs-comment"># 删除所有失效日期小于当前日期的session</span>

request.session.set_expiry(value)  <span class="hljs-comment"># 设置session、cookie有效期</span>
								<span class="hljs-comment"># 整数：指定秒后过期；</span>
    							<span class="hljs-comment"># datatime或timedelta：指定时间过期；</span>
        						<span class="hljs-comment"># 0：用户关闭浏览器时过期</span></code></pre>

<h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><pre><code class="hljs python"></code></pre>

<h2 id="Transaction-事务"><a href="#Transaction-事务" class="headerlink" title="Transaction 事务"></a>Transaction 事务</h2><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> transaction


<span class="hljs-comment"># 装饰器用法</span>
<span class="hljs-meta">@transaction.atomic</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span>(<span class="hljs-params">request</span>):</span>
    <span class="hljs-comment"># 函数下所有代码会在一个事务中执行</span>
    <span class="hljs-keyword">pass</span>


<span class="hljs-comment"># with用法，更灵活</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">func</span>(<span class="hljs-params">request</span>):</span>
    <span class="hljs-comment"># 这部分代码不在事务中，会被 Django 自动提交</span>
    <span class="hljs-keyword">pass</span>

    <span class="hljs-keyword">with</span> transaction.atomic():
        <span class="hljs-comment"># 这部分代码会在事务中执行</span>

        s1 = transaction.savepoint()  <span class="hljs-comment"># 设置保存点，可设置多个</span>

        transaction.savepoint_rollback(s1)  <span class="hljs-comment"># 事务回滚至指定保存点</span>

        transaction.savepoint_commit(s1)  <span class="hljs-comment"># 提交事务</span>

        <span class="hljs-keyword">pass</span></code></pre>

<h2 id="ORM"><a href="#ORM" class="headerlink" title="ORM"></a>ORM</h2><h3 id="查询条件"><a href="#查询条件" class="headerlink" title="查询条件"></a>查询条件</h3><pre><code class="hljs sh"><span class="hljs-comment"># 使用方式，字段__条件</span>

exact  <span class="hljs-comment"># 精准 =</span>
iexact  <span class="hljs-comment"># 精准 =，忽略大小写</span>
contains  <span class="hljs-comment"># 包含</span>
icontains  <span class="hljs-comment"># 包含，忽略大小写</span>
<span class="hljs-keyword">in</span>  <span class="hljs-comment"># 在容器中</span>
gt  <span class="hljs-comment"># 大于 &gt;</span>
gte  <span class="hljs-comment"># 大于等于 &gt;=</span>
lt  <span class="hljs-comment"># 小于 &lt;</span>
lte  <span class="hljs-comment"># 小于等于 &lt;=</span>
startswith  <span class="hljs-comment"># 字段以给定值开始</span>
istartswith  <span class="hljs-comment"># 字段以给定值开始，忽略大小写</span>
endswith  <span class="hljs-comment"># 字段以给定值结束</span>
iendswith  <span class="hljs-comment"># 字段以给定值结束，忽略大小写</span>
range  <span class="hljs-comment"># 用于指定容器范围，并查询容器范围的数据</span>
date  <span class="hljs-comment"># 针对某些date或者datetime类型的字段，根据date部分进行过滤(年月日)</span>
time  <span class="hljs-comment"># 根据时间来进行查询：比较日期时间(datetime)字段的时间部分</span>
year  <span class="hljs-comment"># 根据年份进行查询</span>
isnull  <span class="hljs-comment"># 对应SQL语句中的IS NULL和IS NOT NULL，可接受参数为True和False</span>
regex  <span class="hljs-comment"># 根据指定的正则表达式来查询</span>
iregex  <span class="hljs-comment"># 根据指定的正则表达式来查询，忽略大小写</span></code></pre>

<h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.db.models <span class="hljs-keyword">import</span> F
<span class="hljs-comment"># name字段为null的，排最前面</span>
.order_by(F(<span class="hljs-string">&#x27;name&#x27;</span>).asc(nulls_first=<span class="hljs-literal">True</span>), <span class="hljs-string">&#x27;create_time&#x27;</span>)
<span class="hljs-comment"># name字段为null的，排最后边</span>
.order_by(F(<span class="hljs-string">&#x27;name&#x27;</span>).asc(nulls_last=<span class="hljs-literal">True</span>), <span class="hljs-string">&#x27;create_time&#x27;</span>)</code></pre>



<pre><code class="hljs python"><span class="hljs-comment"># 查不到返回404</span>
get_object_or_404()</code></pre>



<h2 id="DRF-框架"><a href="#DRF-框架" class="headerlink" title="DRF 框架"></a>DRF 框架</h2><h3 id="安装DRF"><a href="#安装DRF" class="headerlink" title="安装DRF"></a>安装DRF</h3><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> djangorestframework  <span class="hljs-comment"># drf框架</span>
pip <span class="hljs-keyword">install</span> django-filter <span class="hljs-comment"># 过滤器</span></code></pre>

<p><strong>setting.py 配置</strong></p>
<pre><code class="hljs PYTHON">INSTALLED_APPS = [
	...
    <span class="hljs-string">&#x27;rest_framework&#x27;</span>,
    <span class="hljs-string">&#x27;django_filters&#x27;</span>,
    
    <span class="hljs-string">&#x27;apps.book&#x27;</span>,
    ...
]
...
REST_FRAMEWORK = &#123;
    <span class="hljs-comment"># 返回时间格式</span>
    <span class="hljs-string">&#x27;DATETIME_FORMAT&#x27;</span>: <span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>,
    <span class="hljs-comment"># 自定义异常响应格式</span>
    <span class="hljs-string">&#x27;EXCEPTION_HANDLER&#x27;</span>: <span class="hljs-string">&#x27;utils.custom_exception.custom_exception_handler&#x27;</span>,
    <span class="hljs-comment"># # 认证</span>
    <span class="hljs-comment"># &#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;: (</span>
    <span class="hljs-comment">#     &#x27;rest_framework.authentication.BasicAuthentication&#x27;,</span>
    <span class="hljs-comment">#     &#x27;rest_framework.authentication.SessionAuthentication&#x27;,</span>
    <span class="hljs-comment"># ),</span>
    <span class="hljs-comment"># # 权限</span>
    <span class="hljs-comment"># &#x27;DEFAULT_PERMISSION_CLASSES&#x27;: (</span>
    <span class="hljs-comment">#     &#x27;rest_framework.permissions.IsAuthenticated&#x27;,</span>
    <span class="hljs-comment"># ),</span>
    <span class="hljs-comment"># 限流</span>
    <span class="hljs-string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: (
        <span class="hljs-string">&#x27;rest_framework.throttling.AnonRateThrottle&#x27;</span>,  <span class="hljs-comment"># 游客</span>
        <span class="hljs-string">&#x27;rest_framework.throttling.UserRateThrottle&#x27;</span>  <span class="hljs-comment"># 用户</span>
    ),
    <span class="hljs-string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;
        <span class="hljs-string">&#x27;anon&#x27;</span>: <span class="hljs-string">&#x27;100/day&#x27;</span>,
        <span class="hljs-string">&#x27;user&#x27;</span>: <span class="hljs-string">&#x27;10/second&#x27;</span>
    &#125;,
    <span class="hljs-comment"># 过滤</span>
    <span class="hljs-string">&#x27;DEFAULT_FILTER_BACKENDS&#x27;</span>: (<span class="hljs-string">&#x27;django_filters.rest_framework.DjangoFilterBackend&#x27;</span>,)
&#125;</code></pre>

<h3 id="DRF的基本使用"><a href="#DRF的基本使用" class="headerlink" title="DRF的基本使用"></a>DRF的基本使用</h3><p><strong>models.py</strong></p>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> models


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Author</span>(<span class="hljs-params">models.Model</span>):</span>
    GENDERS = (
        (<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;男&#x27;</span>),
        (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;女&#x27;</span>)
    )
    name = models.CharField(max_length=<span class="hljs-number">20</span>, verbose_name=<span class="hljs-string">&#x27;名字&#x27;</span>)
    gender = models.IntegerField(default=<span class="hljs-number">0</span>, choices=GENDERS, verbose_name=<span class="hljs-string">&#x27;性别&#x27;</span>)
    created = models.DateTimeField(auto_now_add=<span class="hljs-literal">True</span>, verbose_name=<span class="hljs-string">&#x27;创建时间&#x27;</span>)
    updated = models.DateTimeField(auto_now=<span class="hljs-literal">True</span>, verbose_name=<span class="hljs-string">&#x27;更新时间&#x27;</span>)
    deleted = models.IntegerField(default=<span class="hljs-number">0</span>, verbose_name=<span class="hljs-string">&#x27;逻辑删除&#x27;</span>)

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        <span class="hljs-comment"># managed = False</span>
        db_table = <span class="hljs-string">&#x27;author&#x27;</span>

    <span class="hljs-comment"># 逻辑删除</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete</span>(<span class="hljs-params">self, using=<span class="hljs-literal">None</span>, keep_parents=<span class="hljs-literal">False</span></span>):</span>
        self.deleted = <span class="hljs-number">1</span>
        self.save()


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Book</span>(<span class="hljs-params">models.Model</span>):</span>
    name = models.CharField(max_length=<span class="hljs-number">30</span>, default=<span class="hljs-string">&#x27;&#x27;</span>, verbose_name=<span class="hljs-string">&#x27;书名&#x27;</span>)
    author = models.ForeignKey(Author, on_delete=models.CASCADE, db_constraint=<span class="hljs-literal">False</span>,
                               related_name=<span class="hljs-string">&#x27;作者&#x27;</span>)  <span class="hljs-comment"># db_constraint=False：数据库不使用外键，仅django内部使用</span>
    price = models.IntegerField(default=<span class="hljs-number">0</span>, verbose_name=<span class="hljs-string">&#x27;价格&#x27;</span>)
    seq = models.IntegerField(default=<span class="hljs-number">0</span>, verbose_name=<span class="hljs-string">&#x27;顺序&#x27;</span>)
    created = models.DateTimeField(auto_now_add=<span class="hljs-literal">True</span>, verbose_name=<span class="hljs-string">&#x27;创建时间&#x27;</span>)
    updated = models.DateTimeField(auto_now=<span class="hljs-literal">True</span>, verbose_name=<span class="hljs-string">&#x27;更新时间&#x27;</span>)
    deleted = models.IntegerField(default=<span class="hljs-number">0</span>, verbose_name=<span class="hljs-string">&#x27;逻辑删除&#x27;</span>)

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        <span class="hljs-comment"># managed = False</span>
        db_table = <span class="hljs-string">&#x27;book&#x27;</span></code></pre>

<p><strong>urls.py</strong></p>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> django.urls <span class="hljs-keyword">import</span> path
<span class="hljs-keyword">from</span> rest_framework <span class="hljs-keyword">import</span> routers
<span class="hljs-keyword">from</span> apps.book.views <span class="hljs-keyword">import</span> BookView

urlpatterns = [
    <span class="hljs-comment"># path(&#x27;books&#x27;, BookView.as_view(&#123;&#x27;get&#x27;: &#x27;list&#x27;&#125;)),</span>
]

<span class="hljs-comment"># trailing_slash为False，url不自动添加尾斜杠</span>
router = routers.SimpleRouter(trailing_slash=<span class="hljs-literal">False</span>)
router.register(<span class="hljs-string">r&#x27;author&#x27;</span>, AuthorView, basename=<span class="hljs-string">&#x27;author&#x27;</span>)
router.register(<span class="hljs-string">r&#x27;book&#x27;</span>, BookView2, basename=<span class="hljs-string">&#x27;book&#x27;</span>)

urlpatterns += router.urls</code></pre>

<p><strong>serializer.py</strong></p>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> rest_framework <span class="hljs-keyword">import</span> serializers

<span class="hljs-keyword">from</span> apps.demo.models <span class="hljs-keyword">import</span> Book, Author


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthorSerializer</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span>
    gender = serializers.CharField(source=<span class="hljs-string">&#x27;get_gender_display&#x27;</span>, read_only=<span class="hljs-literal">True</span>, required=<span class="hljs-literal">False</span>)

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        model = Author
        fields = <span class="hljs-string">&#x27;__all__&#x27;</span>  <span class="hljs-comment"># 返回字段，__all__ 代表所有</span>


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookSerializer</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;</span>
<span class="hljs-string">    read_only：只在查询时有效</span>
<span class="hljs-string">    write_only：只在写入时有效</span>
<span class="hljs-string">    &quot;&quot;&quot;</span>
    author = serializers.CharField(label=<span class="hljs-string">&#x27;作者&#x27;</span>, source=<span class="hljs-string">&#x27;author_id.name&#x27;</span>, read_only=<span class="hljs-literal">True</span>)
    <span class="hljs-comment"># author_id = serializers.PrimaryKeyRelatedField(label=&#x27;作者&#x27;, read_only=True)</span>

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        model = Book
        fields = <span class="hljs-string">&#x27;__all__&#x27;</span>  <span class="hljs-comment"># 返回字段，__all__ 代表所有</span></code></pre>

<p><strong>views.py</strong></p>
<pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthorView</span>(<span class="hljs-params">ModelViewSet</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;</span>
<span class="hljs-string">    新增：POST /author</span>
<span class="hljs-string">    删除：DELETE /author/1</span>
<span class="hljs-string">    修改：PATCH /author/1</span>
<span class="hljs-string">    作者列表查询：GET /author</span>
<span class="hljs-string">    作者图书查询：GET /author/&#123;pk&#125;/book</span>
<span class="hljs-string">    &quot;&quot;&quot;</span>
    queryset = Author.objects.<span class="hljs-built_in">filter</span>(deleted=<span class="hljs-number">0</span>)
    serializer_class = AuthorSerializer

<span class="hljs-meta">    @action(methods=[&#x27;get&#x27;], detail=True, serializer_class=BookSerializer)</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">book</span>(<span class="hljs-params">self, request, pk=<span class="hljs-literal">None</span>, *args, **kwargs</span>):</span>
        self.queryset = Book.objects.<span class="hljs-built_in">filter</span>(deleted=<span class="hljs-number">0</span>, author=pk)
        <span class="hljs-keyword">return</span> self.<span class="hljs-built_in">list</span>(self, request, *args, **kwargs)


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookView</span>(<span class="hljs-params">APIView</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;</span>
<span class="hljs-string">    新增：POST /book</span>
<span class="hljs-string">    &quot;&quot;&quot;</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">post</span>(<span class="hljs-params">self, request, *args, **kwargs</span>):</span>
        <span class="hljs-comment"># 创建或更新</span>
        name = request.data.pop(<span class="hljs-string">&#x27;name&#x27;</span>)
        res, created = Book.objects.update_or_create(defaults=request.data, name=name)
        ser = BookSerializer(res)
        <span class="hljs-keyword">return</span> Response(ser.data)</code></pre>

<h3 id="Serializer-py-序列化器"><a href="#Serializer-py-序列化器" class="headerlink" title="Serializer.py 序列化器"></a>Serializer.py 序列化器</h3><p><strong>序列化：</strong>对查询结果处理</p>
<p><strong>反序列化：</strong>对接收参数处理</p>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> rest_framework <span class="hljs-keyword">import</span> serializers
<span class="hljs-keyword">from</span> apps.book.models <span class="hljs-keyword">import</span> Book

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookSerializer</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;</span>
<span class="hljs-string">    read_only：只在查询时有效</span>
<span class="hljs-string">    write_only：只在写入时有效</span>
<span class="hljs-string">    &quot;&quot;&quot;</span>
    name = serializers.CharField(max_length=<span class="hljs-number">30</span>)
    author = serializers.CharField(max_length=<span class="hljs-number">30</span>)
    price = serializers.IntegerField(required=<span class="hljs-literal">False</span>)
    seq = serializers.IntegerField(required=<span class="hljs-literal">False</span>)
    author = serializers.CharField(read_only=<span class="hljs-literal">True</span>, source=<span class="hljs-string">&#x27;author.name&#x27;</span>)  <span class="hljs-comment"># 序列化外键字段</span>

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        model = Book
        fields = <span class="hljs-string">&#x27;__all__&#x27;</span>  <span class="hljs-comment"># 返回字段，__all__ 代表所有</span>
        exclude = (<span class="hljs-string">&#x27;seq&#x27;</span>,)  <span class="hljs-comment"># 除了seq 字段，其他都序列化</span>
        <span class="hljs-comment"># 指定字段说明</span>
        extra_kwargs = &#123;
            <span class="hljs-string">&#x27;name&#x27;</span>: &#123;<span class="hljs-string">&#x27;write_only&#x27;</span>: <span class="hljs-literal">True</span>&#125;,
            <span class="hljs-string">&#x27;author&#x27;</span>: &#123;<span class="hljs-string">&#x27;write_only&#x27;</span>: <span class="hljs-literal">True</span>&#125;,
            <span class="hljs-string">&#x27;price&#x27;</span>: &#123;<span class="hljs-string">&#x27;write_only&#x27;</span>: <span class="hljs-literal">True</span>&#125;
        &#125;
        
    <span class="hljs-comment"># 改变序列输出行为</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">to_representation</span>(<span class="hljs-params">self, instance</span>):</span>
        ret = <span class="hljs-built_in">super</span>().to_representation(instance)
        <span class="hljs-comment"># json字符串 =&gt; 字典</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;field&#x27;</span> <span class="hljs-keyword">in</span> ret:
            <span class="hljs-keyword">try</span>:
                ret[<span class="hljs-string">&#x27;field&#x27;</span>] = json.loads(ret[<span class="hljs-string">&#x27;field&#x27;</span>])
            <span class="hljs-keyword">except</span> ValueError:
                <span class="hljs-keyword">pass</span>
        <span class="hljs-keyword">return</span> ret</code></pre>

<p><strong>view.py</strong></p>
<pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookView</span>(<span class="hljs-params">APIView</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">post</span>(<span class="hljs-params">self, request, *args, **kwargs</span>):</span>
        <span class="hljs-comment"># 创建或更新</span>
        name = request.data.pop(<span class="hljs-string">&#x27;name&#x27;</span>)
        res, created = Book.objects.update_or_create(defaults=request.data, name=name)
        ser = BookSerializer(res)
        <span class="hljs-keyword">return</span> Response(ser.data)
    
  BookSerializer(res, many)</code></pre>

<h4 id="嵌套序列化"><a href="#嵌套序列化" class="headerlink" title="嵌套序列化"></a>嵌套序列化</h4><pre><code class="hljs python"><span class="hljs-comment">## models.py</span>
<span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> models


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Author</span>(<span class="hljs-params">models.Model</span>):</span>
    name = models.CharField(max_length=<span class="hljs-number">20</span>)

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        <span class="hljs-comment"># managed = False</span>
        db_table = <span class="hljs-string">&#x27;author&#x27;</span>
        app_label = <span class="hljs-string">&#x27;demo&#x27;</span>


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Book</span>(<span class="hljs-params">models.Model</span>):</span>
    name = models.CharField(max_length=<span class="hljs-number">30</span>)
    author = models.ForeignKey(Author, on_delete=models.CASCADE, related_name=<span class="hljs-string">&#x27;books&#x27;</span>, db_constraint=<span class="hljs-literal">False</span>)  <span class="hljs-comment"># db_constraint=False：数据库不使用外键，仅django内部使用</span>

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        <span class="hljs-comment"># managed = False</span>
        db_table = <span class="hljs-string">&#x27;book&#x27;</span>
        app_label = <span class="hljs-string">&#x27;demo&#x27;</span></code></pre>

<h5 id="常规嵌套"><a href="#常规嵌套" class="headerlink" title="常规嵌套"></a>常规嵌套</h5><pre><code class="hljs python"><span class="hljs-comment"># 书籍嵌套作者</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthorSerializer</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span>
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        model = Author
        fields = <span class="hljs-string">&#x27;__all__&#x27;</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookSerializer</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span>
    author = AuthorSerializer(read_only=<span class="hljs-literal">True</span>, source=<span class="hljs-string">&#x27;author&#x27;</span>)
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        model = Book
        fields = <span class="hljs-string">&#x27;__all__&#x27;</span>

<span class="hljs-comment"># 作者嵌套书籍</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookSerializer</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span>
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        model = Book
        fields = <span class="hljs-string">&#x27;__all__&#x27;</span>
        
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthorSerializer</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span>
    books = AuthorSerializer(read_only=<span class="hljs-literal">True</span>, source=<span class="hljs-string">&#x27;books&#x27;</span>， many=<span class="hljs-literal">True</span>)
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        model = Author
        fields = <span class="hljs-string">&#x27;__all__&#x27;</span></code></pre>

<h5 id="从下往上查"><a href="#从下往上查" class="headerlink" title="从下往上查"></a>从下往上查</h5><pre><code class="hljs python"><span class="hljs-comment">## serializer.py</span>
<span class="hljs-keyword">from</span> rest_framework <span class="hljs-keyword">import</span> serializers

<span class="hljs-comment"># 底层往上查</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookSerializer</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span>
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        model = Book
        fields = <span class="hljs-string">&#x27;__all__&#x27;</span>
        depth = <span class="hljs-number">2</span>  <span class="hljs-comment"># 递归深度</span></code></pre>

<h5 id="从上往下查"><a href="#从上往下查" class="headerlink" title="从上往下查"></a>从上往下查</h5><pre><code class="hljs python"><span class="hljs-comment">## serializer.py</span>
<span class="hljs-keyword">from</span> rest_framework <span class="hljs-keyword">import</span> serializers
        
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookSerializer</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span>
    <span class="hljs-comment"># 多对一序列化。author_id：外键字段名</span>
    author = serializers.CharField(label=<span class="hljs-string">&#x27;作者&#x27;</span>, source=<span class="hljs-string">&#x27;author_id.name&#x27;</span>, read_only=<span class="hljs-literal">True</span>)
    <span class="hljs-comment">#image_list = ProductImageSerializer(source=&#x27;product_info&#x27;, read_only=True, many=True)</span>

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        model = Book
        fields = <span class="hljs-string">&#x27;__all__&#x27;</span></code></pre>

<h5 id="多级嵌套"><a href="#多级嵌套" class="headerlink" title="多级嵌套"></a>多级嵌套</h5><pre><code class="hljs python"><span class="hljs-comment">## models.py</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Area</span>(<span class="hljs-params">models.Model</span>):</span>
    p_id = models.ForeignKey(<span class="hljs-string">&#x27;self&#x27;</span>, db_column=<span class="hljs-string">&#x27;p_id&#x27;</span>, db_constraint=<span class="hljs-literal">False</span>, on_delete=models.SET_DEFAULT, default=<span class="hljs-number">0</span>, verbose_name=<span class="hljs-string">&#x27;地区&#x27;</span>, related_name=<span class="hljs-string">&#x27;children&#x27;</span>)
    name = models.CharField(max_length=<span class="hljs-number">50</span>, verbose_name=<span class="hljs-string">&#x27;地区名&#x27;</span>)

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        db_table = <span class="hljs-string">&#x27;area&#x27;</span>
        

<span class="hljs-comment">## serializer.py</span>
<span class="hljs-keyword">from</span> rest_framework <span class="hljs-keyword">import</span> serializers


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AreaSerializer3</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span>
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        model = Area
        fields = <span class="hljs-string">&#x27;__all__&#x27;</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AreaSerializer2</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span>
    children = AreaSerializer3(many=<span class="hljs-literal">True</span>, read_only=<span class="hljs-literal">True</span>)

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        model = Area
        fields = <span class="hljs-string">&#x27;__all__&#x27;</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AreaSerializer</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span>
    children = AreaSerializer2(many=<span class="hljs-literal">True</span>, read_only=<span class="hljs-literal">True</span>)

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        model = Area
        fields = <span class="hljs-string">&#x27;__all__&#x27;</span>

        
<span class="hljs-comment">## views.py</span>
<span class="hljs-keyword">from</span> rest_framework <span class="hljs-keyword">import</span> mixins
<span class="hljs-keyword">from</span> rest_framework.viewsets <span class="hljs-keyword">import</span> GenericViewSet

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AreaView</span>(<span class="hljs-params">GenericViewSet, mixins.ListModelMixin</span>):</span>
    queryset = Area.objects.<span class="hljs-built_in">filter</span>(pid=<span class="hljs-number">0</span>)
    serializer_class = AreaSerializer</code></pre>

<h5 id="递归嵌套"><a href="#递归嵌套" class="headerlink" title="递归嵌套"></a>递归嵌套</h5><pre><code class="hljs python"><span class="hljs-comment">## models.py</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Area</span>(<span class="hljs-params">models.Model</span>):</span>
    p_id = models.ForeignKey(<span class="hljs-string">&#x27;self&#x27;</span>, null=<span class="hljs-literal">True</span>, db_column=<span class="hljs-string">&#x27;p_id&#x27;</span>, db_constraint=<span class="hljs-literal">False</span>, on_delete=models.CASCADE, verbose_name=<span class="hljs-string">&#x27;地区&#x27;</span>)
    name = models.CharField(max_length=<span class="hljs-number">50</span>, verbose_name=<span class="hljs-string">&#x27;地区名&#x27;</span>)

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        db_table = <span class="hljs-string">&#x27;area&#x27;</span>

        
<span class="hljs-comment">## serializer.py</span>
<span class="hljs-keyword">from</span> rest_framework <span class="hljs-keyword">import</span> serializers

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AreaSerializer</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span>
    children = serializers.SerializerMethodField()

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        model = Area
        fields = <span class="hljs-string">&#x27;__all__&#x27;</span>
        
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_children</span>(<span class="hljs-params">self, obj</span>)</span>
        res = Area.objects.filter(p_id=obj.id)
        <span class="hljs-keyword">return</span> AreaSerializer(res, many=<span class="hljs-literal">True</span>).data

    
<span class="hljs-comment">## views.py</span>
<span class="hljs-keyword">from</span> rest_framework <span class="hljs-keyword">import</span> mixins
<span class="hljs-keyword">from</span> rest_framework.viewsets <span class="hljs-keyword">import</span> GenericViewSet

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AreaView</span>(<span class="hljs-params">GenericViewSet, mixins.ListModelMixin</span>):</span>
    queryset = Area.objects.<span class="hljs-built_in">filter</span>(pid=<span class="hljs-literal">None</span>)
    serializer_class = AreaSerializer</code></pre>

<h4 id="ChoiceDield"><a href="#ChoiceDield" class="headerlink" title="ChoiceDield"></a>ChoiceDield</h4><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span>(<span class="hljs-params">models.Model</span>):</span>
    GENDERS = (
        (<span class="hljs-number">0</span>, <span class="hljs-string">&#x27;男&#x27;</span>),
        (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;女&#x27;</span>),
    )
    gender = models.IntegerField(default=<span class="hljs-number">0</span>, choices=GENDERS)
    

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserSerializer</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span>
    <span class="hljs-comment"># 使用 get_&lt;字段名&gt;_display的方法</span>
    gender = serializers.CharField(source=<span class="hljs-string">&#x27;get_gender_display&#x27;</span>, required=<span class="hljs-literal">False</span>)
    
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        model = User
        fields = <span class="hljs-string">&#x27;__all__&#x27;</span></code></pre>

<h4 id="获取数据"><a href="#获取数据" class="headerlink" title="获取数据"></a>获取数据</h4><pre><code class="hljs python"><span class="hljs-comment">## views.py</span>
<span class="hljs-comment"># 传参</span>
self.kwargs[<span class="hljs-string">&#x27;user_id&#x27;</span>] = <span class="hljs-number">123</span>

<span class="hljs-comment">## serializer.py</span>
<span class="hljs-comment"># 取参</span>
self.context.get(<span class="hljs-string">&#x27;view&#x27;</span>).kwargs</code></pre>

<h4 id="序列化器调用"><a href="#序列化器调用" class="headerlink" title="序列化器调用"></a>序列化器调用</h4><pre><code class="hljs python"><span class="hljs-comment"># 创建</span>
ser = BookSerializer(data)
<span class="hljs-keyword">if</span> ser.is_valid():
    ser.save()
    
<span class="hljs-comment"># 更新</span>
instance = Book.objects.<span class="hljs-built_in">filter</span>(<span class="hljs-built_in">id</span>=<span class="hljs-number">1</span>).first()
ser = BookSerializer(instance, data)
<span class="hljs-comment"># ser = BookSerializer(instance=instance, data=data, partial=True)  # 部分更新</span>
<span class="hljs-keyword">if</span> ser.is_valid():
    ser.save()
</code></pre>



<h4 id="重写方法"><a href="#重写方法" class="headerlink" title="重写方法"></a>重写方法</h4><pre><code class="hljs python"><span class="hljs-comment">##views.py</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderView</span>(<span class="hljs-params">GenericAPIView, mixins.CreateModelMixin</span>):</span>
    authentication_classes = [FreshSessionAuth]
    queryset = OrderMaster.objects.<span class="hljs-built_in">filter</span>(deleted=<span class="hljs-number">0</span>)
    serializer_class = OrderMasterSerializer

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">post</span>(<span class="hljs-params">self, request, *args, **kwargs</span>):</span>
        self.kwargs[<span class="hljs-string">&#x27;user_id&#x27;</span>] = <span class="hljs-number">123</span>
        <span class="hljs-keyword">return</span> self.create(request, *args, **kwargs)

<span class="hljs-comment">##serializer.py</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderMasterSerializer</span>(<span class="hljs-params">serializers.ModelSerializer</span>):</span>
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        model = OrderMaster
        fields = <span class="hljs-string">&#x27;__all__&#x27;</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create</span>(<span class="hljs-params">self, validated_data</span>):</span>
        user_id = self.context.get(<span class="hljs-string">&#x27;view&#x27;</span>).kwargs.get(<span class="hljs-string">&#x27;user_id&#x27;</span>)
        validated_data[<span class="hljs-string">&#x27;user_id&#x27;</span>] = user_id
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().create(validated_data)
        <span class="hljs-comment"># return OrderMaster.objects.create(**validated_data)</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span>(<span class="hljs-params">self, instance, validated_data</span>):</span>
        <span class="hljs-keyword">if</span> validated_data.get(<span class="hljs-string">&#x27;pay_state&#x27;</span>) == <span class="hljs-number">1</span>:
            validated_data[<span class="hljs-string">&#x27;order_state&#x27;</span>] = <span class="hljs-number">1</span>
            
        <span class="hljs-built_in">super</span>().update(instance, validated_data)
        <span class="hljs-keyword">return</span> instance</code></pre>

<h3 id="Filters-py-过滤器"><a href="#Filters-py-过滤器" class="headerlink" title="Filters.py 过滤器"></a>Filters.py 过滤器</h3><pre><code class="hljs python"><span class="hljs-comment">## filters.py</span>

<span class="hljs-keyword">from</span> django_filters <span class="hljs-keyword">import</span> filters
<span class="hljs-keyword">from</span> django_filters.rest_framework <span class="hljs-keyword">import</span> FilterSet
<span class="hljs-keyword">from</span> apps.book.models <span class="hljs-keyword">import</span> Book

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookFilter</span>(<span class="hljs-params">FilterSet</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;</span>
<span class="hljs-string">    field_name：指定字段，默认同名</span>
<span class="hljs-string">    lookup_expr：匹配方式，orm同款</span>
<span class="hljs-string">    &quot;&quot;&quot;</span>
    name = filters.CharFilter(field_name=<span class="hljs-string">&#x27;name&#x27;</span>, lookup_expr=<span class="hljs-string">&#x27;icontains&#x27;</span>)

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        model = Book
        fields = [<span class="hljs-string">&#x27;is_delete&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>]  <span class="hljs-comment"># 过滤条件, 精准匹配</span>
        <span class="hljs-comment"># or</span>
        fields = &#123;
            <span class="hljs-string">&#x27;is_delete&#x27;</span>: [<span class="hljs-string">&#x27;exact&#x27;</span>, <span class="hljs-string">&#x27;contains&#x27;</span>],
            <span class="hljs-string">&#x27;name&#x27;</span>: [<span class="hljs-string">&#x27;exact&#x27;</span>, <span class="hljs-string">&#x27;contains&#x27;</span>],
        &#125;</code></pre>

<h3 id="Pages-py-分页器"><a href="#Pages-py-分页器" class="headerlink" title="Pages.py 分页器"></a>Pages.py 分页器</h3><pre><code class="hljs python"><span class="hljs-keyword">from</span> rest_framework.pagination <span class="hljs-keyword">import</span> PageNumberPagination

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LargePagination</span>(<span class="hljs-params">PageNumberPagination</span>):</span>
    page_size = <span class="hljs-number">100</span>  <span class="hljs-comment"># 每页显示数量</span>
    page_size_query_param = <span class="hljs-string">&#x27;page_size&#x27;</span>  <span class="hljs-comment"># 分页控件的查询参数的名称</span>
    max_page_size = <span class="hljs-number">10000</span>  <span class="hljs-comment"># 允许的最大页面大小。该属性仅在 page_size_query_param 也被设置时有效</span>


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StandardPagination</span>(<span class="hljs-params">PageNumberPagination</span>):</span>
    page_size = <span class="hljs-number">10</span>
    page_size_query_param = <span class="hljs-string">&#x27;page_size&#x27;</span>
    max_page_size = <span class="hljs-number">1000</span></code></pre>

<h3 id="APIView类视图"><a href="#APIView类视图" class="headerlink" title="APIView类视图"></a>APIView类视图</h3><pre><code class="hljs python"><span class="hljs-keyword">from</span> rest_framework.views <span class="hljs-keyword">import</span> APIView

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookView</span>(<span class="hljs-params">APIView</span>):</span>
    renderer_classes = []  <span class="hljs-comment"># 自定义过滤器</span>
    authentication_classes = []  <span class="hljs-comment"># 自定义认证</span>
    throttle_classes = []  <span class="hljs-comment"># 自定义限流</span>
    permission_classes = []  <span class="hljs-comment"># 自定义权限</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self, request</span>):</span>
        <span class="hljs-keyword">pass</span>
        
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">post</span>(<span class="hljs-params">self, request</span>):</span>
        <span class="hljs-keyword">pass</span></code></pre>

<h3 id="ModelViewSet-视图集"><a href="#ModelViewSet-视图集" class="headerlink" title="ModelViewSet 视图集"></a>ModelViewSet 视图集</h3><pre><code class="hljs python"><span class="hljs-keyword">from</span> django_filters.rest_framework <span class="hljs-keyword">import</span> DjangoFilterBackend
<span class="hljs-keyword">from</span> rest_framework.authentication <span class="hljs-keyword">import</span> SessionAuthentication, BasicAuthentication
<span class="hljs-keyword">from</span> rest_framework.filters <span class="hljs-keyword">import</span> SearchFilter, OrderingFilter
<span class="hljs-keyword">from</span> rest_framework.pagination <span class="hljs-keyword">import</span> PageNumberPagination
<span class="hljs-keyword">from</span> rest_framework.permissions <span class="hljs-keyword">import</span> IsAuthenticated
<span class="hljs-keyword">from</span> rest_framework.viewsets <span class="hljs-keyword">import</span> ModelViewSet

<span class="hljs-keyword">from</span> apps.book.models <span class="hljs-keyword">import</span> Book
<span class="hljs-keyword">from</span> apps.book.filters <span class="hljs-keyword">import</span> BookFilter
<span class="hljs-keyword">from</span> apps.book.pages <span class="hljs-keyword">import</span> LargeSetPagination
<span class="hljs-keyword">from</span> apps.book.serializers <span class="hljs-keyword">import</span> BookSerializer

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookView</span>(<span class="hljs-params">ModelViewSet</span>):</span>
    <span class="hljs-comment"># renderer_classes = []  # 自定义过滤器</span>
    <span class="hljs-comment"># authentication_classes = []  # 自定义认证</span>
    <span class="hljs-comment"># throttle_classes = []  # 自定义限流</span>
    <span class="hljs-comment"># permission_classes = []  # 自定义权限</span>
    <span class="hljs-comment"># http_method_names = [&#x27;get&#x27;, &#x27;post&#x27;,] # 允许请求方式</span>

    queryset = Book.objects.<span class="hljs-built_in">all</span>()
    serializer_class = BookSerializer
    <span class="hljs-comment"># pagination_class = LargeSetPagination  # 自定义分页器</span>

    filter_backends = [DjangoFilterBackend, SearchFilter, OrderingFilter]

    <span class="hljs-comment"># 过滤方案一 filter_class 自定义高级过滤规则</span>
    <span class="hljs-comment"># filter_class = BookFilter  # 与filter_fields相斥，需配置DjangoFilterBackend</span>

    <span class="hljs-comment"># 过滤方案二 filter_fields 精准查询</span>
    <span class="hljs-comment"># filter_backends = [DjangoFilterBackend]  # 全局配置过滤器后 无需配置此项</span>
    filter_fields = [<span class="hljs-string">&#x27;name&#x27;</span>]  <span class="hljs-comment"># url中关键字结合列表内字段各自精准匹配</span>

    <span class="hljs-comment"># 过滤 模糊查询</span>
    <span class="hljs-comment"># filter_backends = [SearchFilter]  # 设置过滤后端</span>
    search_fields = [<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;Author__name&#x27;</span>]  <span class="hljs-comment"># url中的关键字为search，列表内所有字段内做模糊匹配。匹配外键字段是需写：外键名__外键字段</span>

    <span class="hljs-comment"># # 排序</span>
    <span class="hljs-comment"># filter_backends = [OrderingFilter]  # 设置排序后端</span>
    ordering_fields = [<span class="hljs-string">&#x27;seq&#x27;</span>, <span class="hljs-string">&#x27;id&#x27;</span>]  <span class="hljs-comment"># 可排序字段，倒序需在url参数后字段前面加 -</span>
    ordering = [<span class="hljs-string">&#x27;seq&#x27;</span>]  <span class="hljs-comment"># 默认排序</span>

    <span class="hljs-comment"># 分页</span>
    <span class="hljs-comment"># pagination_class = None  # 关闭分页。全局配置后进行关闭</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">retrieve</span>(<span class="hljs-params">self, request, *args, **kwargs</span>):</span>
        print(<span class="hljs-string">&#x27;retrieve&#x27;</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().retrieve(request, *args, **kwargs)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">list</span>(<span class="hljs-params">self, request, *args, **kwargs</span>):</span>
        print(<span class="hljs-string">&#x27;list&#x27;</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().<span class="hljs-built_in">list</span>(request, *args, **kwargs)
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create</span>(<span class="hljs-params">self, request, *args, **kwargs</span>):</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().create(request, *args, **kwargs)</code></pre>

<p>请求示例：</p>
<pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/book?search=王子
http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/book?name=小王子&amp;is_delete=<span class="hljs-number">0</span>
http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/book?ordering=seq,-id</code></pre>

<h3 id="批量创建"><a href="#批量创建" class="headerlink" title="批量创建"></a>批量创建</h3><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookView</span>(<span class="hljs-params">ModelViewSet</span>):</span>
    queryset = Book.objects.<span class="hljs-built_in">all</span>()
    serializer_class = BookSerializer
    http_method_names = [<span class="hljs-string">&#x27;post&#x27;</span>,]
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_serializer</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;data&#x27;</span> <span class="hljs-keyword">in</span> kwargs:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(kwargs[<span class="hljs-string">&#x27;data&#x27;</span>], <span class="hljs-built_in">list</span>):
                kwargs[<span class="hljs-string">&#x27;many&#x27;</span>] = <span class="hljs-literal">True</span>

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().get_serializer(*args, **kwargs)</code></pre>

<h3 id="自定义路由"><a href="#自定义路由" class="headerlink" title="自定义路由"></a>自定义路由</h3><p><strong>urls.py</strong></p>
<pre><code class="hljs python">urlpatterns = [
    <span class="hljs-comment"># 额外行为，单独定义路由。或使用 @action注册配合路由器自动生成</span>
    <span class="hljs-comment"># path(&#x27;books/latest&#x27;, BookView.as_view(&#123;&#x27;get&#x27;: &#x27;latest&#x27;&#125;)),</span>
]

router = routers.SimpleRouter(trailing_slash=<span class="hljs-literal">False</span>)
router.register(<span class="hljs-string">r&#x27;books&#x27;</span>, BookView)
urlpatterns += router.urls</code></pre>

<p><strong>views.py</strong></p>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> rest_framework.decorators <span class="hljs-keyword">import</span> action
<span class="hljs-keyword">from</span> rest_framework.viewsets <span class="hljs-keyword">import</span> ModelViewSet

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookView</span>(<span class="hljs-params">ModelViewSet</span>):</span>
    queryset = Book.objects.<span class="hljs-built_in">filter</span>(is_delete=<span class="hljs-number">0</span>)
    serializer_class = BookSerializer
    
<span class="hljs-meta">    @action(methods=[&#x27;get&#x27;], detail=False)  # 使路由器自动生成该路由。detail=False表示不需要pk</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">latest</span>(<span class="hljs-params">self, request, *args, **kwargs</span>):</span>
        book = Book.objects.latest(<span class="hljs-string">&#x27;id&#x27;</span>)
        ser = self.get_serializer(book)
        <span class="hljs-keyword">return</span> Response(ser.data)
    
    
<span class="hljs-meta">    @action(methods=[&#x27;get&#x27;], detail=True)  # 使路由器自动生成该路由。detail=True表示需要pk，路由为 books/&#123;pk&#125;/lastst</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">latest</span>(<span class="hljs-params">self, request, *args, **kwargs</span>):</span>
        pk = kwargs[<span class="hljs-string">&#x27;pk&#x27;</span>]
        book = Book.objects.latest(<span class="hljs-string">&#x27;id&#x27;</span>)
        ser = self.get_serializer(book)
        <span class="hljs-keyword">return</span> Response(ser.data)</code></pre>

<h3 id="版本控制"><a href="#版本控制" class="headerlink" title="版本控制"></a>版本控制</h3><p><strong>全局配置</strong></p>
<pre><code class="hljs python"><span class="hljs-comment">## settings.py</span>
REST_FRAMEWORK = &#123;
    <span class="hljs-string">&#x27;DEFAULT_VERSIONING_CLASS&#x27;</span>: <span class="hljs-string">&#x27;rest_framework.versioning.NamespaceVersioning&#x27;</span>,
    <span class="hljs-string">&#x27;DEFAULT_VERSION&#x27;</span>: <span class="hljs-string">&#x27;v1&#x27;</span>,  <span class="hljs-comment"># 默认版本(从request对象里取不到，显示的默认值)</span>
    <span class="hljs-string">&#x27;ALLOWED_VERSIONS&#x27;</span>: [<span class="hljs-string">&#x27;v1&#x27;</span>, <span class="hljs-string">&#x27;v2&#x27;</span>],  <span class="hljs-comment"># 允许的版本，与接口文档冲突</span>
    <span class="hljs-string">&#x27;VERSION_PARAM&#x27;</span>: <span class="hljs-string">&#x27;version&#x27;</span>  <span class="hljs-comment"># URL中获取值的key</span>
&#125;

<span class="hljs-comment">## urls.py</span>
path(<span class="hljs-string">r&#x27;v1/api/&#x27;</span>, include((<span class="hljs-string">&#x27;apps.urls&#x27;</span>, <span class="hljs-string">&quot;apps&quot;</span>), namespace=<span class="hljs-string">&quot;v1&quot;</span>)),
path(<span class="hljs-string">r&#x27;v2/api/&#x27;</span>, include((<span class="hljs-string">&#x27;apps.urls&#x27;</span>, <span class="hljs-string">&quot;apps&quot;</span>), namespace=<span class="hljs-string">&quot;v2&quot;</span>)),</code></pre>

<h3 id="自定义异常类响应码"><a href="#自定义异常类响应码" class="headerlink" title="自定义异常类响应码"></a>自定义异常类响应码</h3><p><strong>custom_exceptions.py</strong></p>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> django.utils.translation <span class="hljs-keyword">import</span> gettext_lazy <span class="hljs-keyword">as</span> _
<span class="hljs-keyword">from</span> rest_framework.exceptions <span class="hljs-keyword">import</span> APIException

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HaveExisted</span>(<span class="hljs-params">APIException</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;资源已存在&quot;&quot;&quot;</span>
    status_code = <span class="hljs-number">409</span>
    default_detail = _(<span class="hljs-string">&#x27;Have Existed.&#x27;</span>)
    default_code = <span class="hljs-string">&#x27;have_existed&#x27;</span></code></pre>

<h3 id="自定义异常格式"><a href="#自定义异常格式" class="headerlink" title="自定义异常格式"></a>自定义异常格式</h3><p><strong>全局配置</strong></p>
<pre><code class="hljs python"><span class="hljs-comment">## settings.py</span>
REST_FRAMEWORK = &#123;
    <span class="hljs-comment"># 自定义异常格式</span>
    <span class="hljs-string">&#x27;EXCEPTION_HANDLER&#x27;</span>: <span class="hljs-string">&#x27;utils.custom_exception.custom_exception_handler&#x27;</span>,
&#125;</code></pre>

<p><strong>custom_response_exception.py</strong></p>
<pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span>
<span class="hljs-string">自定义异常响应格式：&#123;&#x27;code&#x27;:0,&#x27;message&#x27;:&#x27;成功&#x27;,&#x27;data&#x27;:[]&#125;</span>
<span class="hljs-string">&quot;&quot;&quot;</span>

<span class="hljs-keyword">from</span> rest_framework.response <span class="hljs-keyword">import</span> Response
<span class="hljs-keyword">from</span> rest_framework.views <span class="hljs-keyword">import</span> exception_handler


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">custom_exception_handler</span>(<span class="hljs-params">exc, context</span>):</span>
    response = exception_handler(exc, context)

    res = &#123;&#125;
    <span class="hljs-keyword">if</span> response <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        res = &#123;
            <span class="hljs-string">&#x27;code&#x27;</span>: <span class="hljs-number">9999</span>,
            <span class="hljs-string">&#x27;message&#x27;</span>: <span class="hljs-string">&#x27;服务器未知错误&#x27;</span>
        &#125;
        <span class="hljs-keyword">return</span> response
    <span class="hljs-keyword">else</span>:
        data = []
        <span class="hljs-comment"># print(&#x27;exception&#x27;, response.status_code, response.data)</span>
        res[<span class="hljs-string">&#x27;code&#x27;</span>] = response.status_code
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(response.data, <span class="hljs-built_in">dict</span>):
            data = <span class="hljs-built_in">dict</span>(response.data)

        <span class="hljs-keyword">if</span> response.status_code &gt;= <span class="hljs-number">500</span>:
            res[<span class="hljs-string">&#x27;message&#x27;</span>] = <span class="hljs-string">&#x27;服务器错误&#x27;</span>

        <span class="hljs-keyword">elif</span> response.status_code == <span class="hljs-number">404</span>:
            res[<span class="hljs-string">&#x27;message&#x27;</span>] = <span class="hljs-string">&#x27;未找到&#x27;</span>

        <span class="hljs-keyword">elif</span> response.status_code == <span class="hljs-number">400</span>:
            res[<span class="hljs-string">&#x27;message&#x27;</span>] = <span class="hljs-string">&#x27;参数错误&#x27;</span>

        <span class="hljs-keyword">elif</span> response.status_code == <span class="hljs-number">401</span>:
            res[<span class="hljs-string">&#x27;message&#x27;</span>] = <span class="hljs-string">&#x27;未认证&#x27;</span>

        <span class="hljs-keyword">elif</span> response.status_code == <span class="hljs-number">403</span>:
            res[<span class="hljs-string">&#x27;message&#x27;</span>] = <span class="hljs-string">&#x27;权限不允许&#x27;</span>

        <span class="hljs-keyword">elif</span> response.status_code == <span class="hljs-number">405</span>:
            res[<span class="hljs-string">&#x27;message&#x27;</span>] = <span class="hljs-string">&#x27;方法不允许&#x27;</span>

        <span class="hljs-keyword">elif</span> response.status_code == <span class="hljs-number">409</span>:
            res[<span class="hljs-string">&#x27;message&#x27;</span>] = <span class="hljs-string">&#x27;资源已存在&#x27;</span>

        <span class="hljs-keyword">else</span>:
            res[<span class="hljs-string">&#x27;message&#x27;</span>] = <span class="hljs-string">&#x27;未知错误&#x27;</span>

        res[<span class="hljs-string">&#x27;data&#x27;</span>] = data
    	<span class="hljs-keyword">return</span> Response(res)</code></pre>

<h3 id="自定义响应格式"><a href="#自定义响应格式" class="headerlink" title="自定义响应格式"></a>自定义响应格式</h3><p><strong>全局配置</strong></p>
<pre><code class="hljs python"><span class="hljs-comment"># setting.py</span>
REST_FRAMEWORK = &#123;
    <span class="hljs-comment"># 自定义响应格式</span>
    <span class="hljs-string">&#x27;DEFAULT_RENDERER_CLASSES&#x27;</span>: [
        <span class="hljs-string">&#x27;utils.custom_response.CustomRenderer&#x27;</span>
    ],
&#125;</code></pre>

<p><strong>custom_response.py</strong></p>
<pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span>
<span class="hljs-string">自定义返回处理格式：&#123;&#x27;code&#x27;:0,&#x27;message&#x27;:&#x27;成功&#x27;,&#x27;data&#x27;:[]&#125;</span>
<span class="hljs-string">&quot;&quot;&quot;</span>

<span class="hljs-keyword">from</span> rest_framework.renderers <span class="hljs-keyword">import</span> JSONRenderer


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomRenderer</span>(<span class="hljs-params">JSONRenderer</span>):</span>
    <span class="hljs-comment"># 重构render方法</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">render</span>(<span class="hljs-params">self, data, accepted_media_type=<span class="hljs-literal">None</span>, renderer_context=<span class="hljs-literal">None</span></span>):</span>
        print(<span class="hljs-string">&#x27;renderer&#x27;</span>, data)
        ret = &#123;&#125;
        <span class="hljs-keyword">if</span> renderer_context:
            <span class="hljs-comment"># 如果返回的data为字典</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(data, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">and</span> data.get(<span class="hljs-string">&#x27;code&#x27;</span>) <span class="hljs-keyword">and</span> data.get(<span class="hljs-string">&#x27;message&#x27;</span>):
                <span class="hljs-string">&#x27;&#x27;&#x27;</span>
<span class="hljs-string">                若响应信息中已有code、message，则pass返回</span>
<span class="hljs-string">                &#x27;&#x27;&#x27;</span>
                ret = data
            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(data, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">and</span> data.get(<span class="hljs-string">&#x27;count&#x27;</span>) <span class="hljs-keyword">and</span> data.get(<span class="hljs-string">&#x27;results&#x27;</span>):
                <span class="hljs-string">&#x27;&#x27;&#x27;</span>
<span class="hljs-string">                若响应信息中已有count、results，则为分页列表消息，对其格式化</span>
<span class="hljs-string">                &#x27;&#x27;&#x27;</span>
                <span class="hljs-comment"># ret[&#x27;code&#x27;] = data.pop(&#x27;code&#x27;, renderer_context[&quot;response&quot;].status_code)</span>
                ret[<span class="hljs-string">&#x27;code&#x27;</span>] = <span class="hljs-number">0</span>
                ret[<span class="hljs-string">&#x27;message&#x27;</span>] = data.pop(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-string">&#x27;成功&#x27;</span>)
                ret[<span class="hljs-string">&#x27;count&#x27;</span>] = data[<span class="hljs-string">&#x27;count&#x27;</span>]
                ret[<span class="hljs-string">&#x27;next&#x27;</span>] = data[<span class="hljs-string">&#x27;next&#x27;</span>]
                ret[<span class="hljs-string">&#x27;previous&#x27;</span>] = data[<span class="hljs-string">&#x27;previous&#x27;</span>]
                ret[<span class="hljs-string">&#x27;data&#x27;</span>] = data[<span class="hljs-string">&#x27;results&#x27;</span>]
            <span class="hljs-keyword">else</span>:
                <span class="hljs-string">&#x27;&#x27;&#x27;</span>
<span class="hljs-string">                若响应信息不是字典，则直接格式化返回</span>
<span class="hljs-string">                &#x27;&#x27;&#x27;</span>
                <span class="hljs-comment"># ret[&#x27;code&#x27;] = renderer_context[&quot;response&quot;].status_code</span>
                ret[<span class="hljs-string">&#x27;code&#x27;</span>] = <span class="hljs-number">0</span>
                ret[<span class="hljs-string">&#x27;message&#x27;</span>] = <span class="hljs-string">&#x27;成功&#x27;</span>
                ret[<span class="hljs-string">&#x27;data&#x27;</span>] = data

            renderer_context[<span class="hljs-string">&quot;response&quot;</span>][<span class="hljs-string">&#x27;status_code&#x27;</span>] = <span class="hljs-number">200</span>
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().render(ret, accepted_media_type, renderer_context)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().render(data, accepted_media_type, renderer_context)</code></pre>



<h3 id="自定义认证"><a href="#自定义认证" class="headerlink" title="自定义认证"></a>自定义认证</h3><h4 id="Session-1"><a href="#Session-1" class="headerlink" title="Session"></a>Session</h4><p><strong>全局配置</strong></p>
<pre><code class="hljs python"><span class="hljs-comment"># setting.py</span>
REST_FRAMEWORK = &#123;
    <span class="hljs-comment"># 自定义认证</span>
    <span class="hljs-string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: (
        <span class="hljs-string">&#x27;utils.custom_authentication.CustomSessionAuth&#x27;</span>,
    ),
&#125;</code></pre>

<p><strong>局部使用</strong></p>
<pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookView</span>(<span class="hljs-params">APIView</span>):</span>
    authentication_classes = [CustomSessionAuth]</code></pre>

<p><strong>保存session</strong></p>
<pre><code class="hljs python">request.session[<span class="hljs-string">&#x27;id&#x27;</span>] = <span class="hljs-number">123</span>
request.session[<span class="hljs-string">&#x27;username&#x27;</span>] = <span class="hljs-string">&#x27;abc&#x27;</span></code></pre>

<p><strong>验证</strong></p>
<pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomSessionAuth</span>(<span class="hljs-params">BaseAuthentication</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">authenticate</span>(<span class="hljs-params">self, request</span>):</span>
        print(<span class="hljs-string">&#x27;session&#x27;</span>, request.session)

        session_key = request.session.session_key
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> session_key:
            <span class="hljs-keyword">raise</span> AuthenticationFailed(<span class="hljs-string">&#x27;未认证&#x27;</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> request.session.get(<span class="hljs-string">&#x27;id&#x27;</span>):
            <span class="hljs-keyword">raise</span> AuthenticationFailed(<span class="hljs-string">&#x27;认证失败&#x27;</span>)

        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span></code></pre>



<h4 id="JWT-Token"><a href="#JWT-Token" class="headerlink" title="JWT Token"></a>JWT Token</h4><p><strong>全局配置</strong></p>
<pre><code class="hljs python"><span class="hljs-comment"># setting.py</span>
REST_FRAMEWORK = &#123;
    <span class="hljs-comment"># 自定义认证</span>
    <span class="hljs-string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: (
        <span class="hljs-string">&#x27;utils.custom_authentication.CustomJWTAuth&#x27;</span>,
    ),
&#125;</code></pre>

<p><strong>局部使用</strong></p>
<pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookView</span>(<span class="hljs-params">APIView</span>):</span>
    authentication_classes = [CustomJWTAuth]</code></pre>

<p><strong>生成 jwt token</strong></p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">import</span> jwt

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_token</span>(<span class="hljs-params">payload</span>):</span>
    print(<span class="hljs-built_in">type</span>(payload))
    t = datetime.datetime.now()

    key = <span class="hljs-string">&#x27;lp&#x27;</span>

    payload[<span class="hljs-string">&#x27;exp&#x27;</span>] = datetime.datetime.utcnow() + datetime.timedelta(seconds=<span class="hljs-number">600</span>)

    token = jwt.encode(payload=payload,
                       key=key,
                       algorithm=<span class="hljs-string">&#x27;HS256&#x27;</span>)
    <span class="hljs-comment"># print(&#x27;create_token &#x27;, token)</span>
    <span class="hljs-keyword">return</span> token</code></pre>

<p><strong>custom_authentication.py</strong></p>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> jwt
<span class="hljs-keyword">from</span> jwt <span class="hljs-keyword">import</span> exceptions
<span class="hljs-keyword">from</span> rest_framework.authentication <span class="hljs-keyword">import</span> BaseAuthentication
<span class="hljs-keyword">from</span> rest_framework.exceptions <span class="hljs-keyword">import</span> AuthenticationFailed

<span class="hljs-keyword">from</span> apps.user.models <span class="hljs-keyword">import</span> UserWechat

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomJWTAuth</span>(<span class="hljs-params">BaseAuthentication</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">authenticate</span>(<span class="hljs-params">self, request</span>):</span>
        token = request.META.get(<span class="hljs-string">&#x27;HTTP_Authorization&#x27;</span>.upper())
        key = <span class="hljs-string">&#x27;lp&#x27;</span>
        payload = <span class="hljs-literal">None</span>
        <span class="hljs-keyword">if</span> token <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">raise</span> AuthenticationFailed(<span class="hljs-string">&#x27;未认证&#x27;</span>)
        <span class="hljs-keyword">try</span>:
            payload = jwt.decode(token, key, algorithms=[<span class="hljs-string">&#x27;HS256&#x27;</span>])
            <span class="hljs-comment"># print(&#x27;validate_token &#x27;, type(payload), payload)</span>
        <span class="hljs-keyword">except</span> exceptions.ExpiredSignatureError:
            <span class="hljs-keyword">raise</span> AuthenticationFailed(<span class="hljs-string">&#x27;签名已失效&#x27;</span>)
        <span class="hljs-keyword">except</span> jwt.DecodeError:
            <span class="hljs-keyword">raise</span> AuthenticationFailed(<span class="hljs-string">&#x27;认证失败&#x27;</span>)
        <span class="hljs-keyword">except</span> jwt.InvalidTokenError:
            <span class="hljs-keyword">raise</span> AuthenticationFailed(<span class="hljs-string">&#x27;签名非法&#x27;</span>)

        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span></code></pre>

<h3 id="自定义权限"><a href="#自定义权限" class="headerlink" title="自定义权限"></a>自定义权限</h3><p><strong>全局配置</strong></p>
<pre><code class="hljs python"><span class="hljs-string">&#x27;DEFAULT_PERMISSION_CLASSES&#x27;</span>: (
	<span class="hljs-string">&#x27;utils.custom_permission.CustomPermission&#x27;</span>,
),</code></pre>

<p><strong>custom_permission.py</strong></p>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> rest_framework.permissions <span class="hljs-keyword">import</span> BasePermission

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomPermission</span>(<span class="hljs-params">BasePermission</span>):</span>
    message = <span class="hljs-string">&#x27;没有权限&#x27;</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">has_permission</span>(<span class="hljs-params">self, request, view</span>):</span>
        print(request.user)
        print(view)
        <span class="hljs-keyword">if</span> <span class="hljs-number">1</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span></code></pre>

<h3 id="自定义限流"><a href="#自定义限流" class="headerlink" title="自定义限流"></a>自定义限流</h3><p><strong>全局配置</strong></p>
<pre><code class="hljs python"><span class="hljs-comment"># 限流</span>
<span class="hljs-string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: (
    <span class="hljs-string">&#x27;utils.custom_throttle.CustomAnonRateThrottle&#x27;</span>,  <span class="hljs-comment"># 自定义游客</span>
    <span class="hljs-string">&#x27;utils.custom_throttle.CustomUserRateThrottle&#x27;</span>,  <span class="hljs-comment"># 自定义用户</span>
),
<span class="hljs-string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;
    <span class="hljs-string">&#x27;anon&#x27;</span>: <span class="hljs-string">&#x27;2/day&#x27;</span>,
    <span class="hljs-string">&#x27;user&#x27;</span>: <span class="hljs-string">&#x27;4/day&#x27;</span>
&#125;,</code></pre>

<p><strong>custom_throttle.py</strong></p>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> rest_framework.throttling <span class="hljs-keyword">import</span> SimpleRateThrottle


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomAnonRateThrottle</span>(<span class="hljs-params">SimpleRateThrottle</span>):</span>
    scope = <span class="hljs-string">&#x27;anon&#x27;</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_cache_key</span>(<span class="hljs-params">self, request, view</span>):</span>
        <span class="hljs-comment"># print(&#x27;限流Anon&#x27;, str(request.user), type(request.user))</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>(request.user) != <span class="hljs-string">&#x27;AnonymousUser&#x27;</span>:  <span class="hljs-comment"># 若不是匿名用户</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>  <span class="hljs-comment"># Only throttle unauthenticated requests.</span>
        <span class="hljs-keyword">return</span> self.cache_format % &#123;
            <span class="hljs-string">&#x27;scope&#x27;</span>: self.scope,
            <span class="hljs-string">&#x27;ident&#x27;</span>: self.get_ident(request)
        &#125;


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomUserRateThrottle</span>(<span class="hljs-params">SimpleRateThrottle</span>):</span>
    scope = <span class="hljs-string">&#x27;user&#x27;</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_cache_key</span>(<span class="hljs-params">self, request, view</span>):</span>
        <span class="hljs-comment"># print(&#x27;限流User&#x27;, request.user)</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>(request.user) != <span class="hljs-string">&#x27;AnonymousUser&#x27;</span>:  <span class="hljs-comment"># 若不是匿名用户</span>
            ident = request.user.<span class="hljs-built_in">id</span>
        <span class="hljs-keyword">else</span>:
            ident = self.get_ident(request)

        <span class="hljs-keyword">return</span> self.cache_format % &#123;
            <span class="hljs-string">&#x27;scope&#x27;</span>: self.scope,
            <span class="hljs-string">&#x27;ident&#x27;</span>: ident
        &#125;</code></pre>



<h2 id="DRF-状态码"><a href="#DRF-状态码" class="headerlink" title="DRF 状态码"></a>DRF 状态码</h2><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span>
<span class="hljs-string">Descriptive HTTP status codes, for code readability.</span>
<span class="hljs-string"></span>
<span class="hljs-string">See RFC 2616 - https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html</span>
<span class="hljs-string">And RFC 6585 - https://tools.ietf.org/html/rfc6585</span>
<span class="hljs-string">And RFC 4918 - https://tools.ietf.org/html/rfc4918</span>
<span class="hljs-string">&quot;&quot;&quot;</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_informational</span>(<span class="hljs-params">code</span>):</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">100</span> &lt;= code &lt;= <span class="hljs-number">199</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_success</span>(<span class="hljs-params">code</span>):</span>  <span class="hljs-comment"># 成功</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">200</span> &lt;= code &lt;= <span class="hljs-number">299</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_redirect</span>(<span class="hljs-params">code</span>):</span>  <span class="hljs-comment"># 重定向</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">300</span> &lt;= code &lt;= <span class="hljs-number">399</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_client_error</span>(<span class="hljs-params">code</span>):</span>  <span class="hljs-comment"># 请求错误</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">400</span> &lt;= code &lt;= <span class="hljs-number">499</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_server_error</span>(<span class="hljs-params">code</span>):</span>  <span class="hljs-comment"># 服务器错误</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">500</span> &lt;= code &lt;= <span class="hljs-number">599</span>

HTTP_100_CONTINUE = <span class="hljs-number">100</span>  <span class="hljs-comment"># 继续</span>
HTTP_101_SWITCHING_PROTOCOLS = <span class="hljs-number">101</span>  <span class="hljs-comment"># 切换协议</span>
HTTP_200_OK = <span class="hljs-number">200</span>  <span class="hljs-comment"># 正常</span>
HTTP_201_CREATED = <span class="hljs-number">201</span>  <span class="hljs-comment"># 已创建</span>
HTTP_202_ACCEPTED = <span class="hljs-number">202</span>  <span class="hljs-comment"># 已接受</span>
HTTP_203_NON_AUTHORITATIVE_INFORMATION = <span class="hljs-number">203</span>  <span class="hljs-comment"># 非授权信息</span>
HTTP_204_NO_CONTENT = <span class="hljs-number">204</span>  <span class="hljs-comment"># 无内容</span>
HTTP_205_RESET_CONTENT = <span class="hljs-number">205</span>  <span class="hljs-comment"># 重置内容</span>
HTTP_206_PARTIAL_CONTENT = <span class="hljs-number">206</span>  <span class="hljs-comment"># 部分内容</span>
HTTP_207_MULTI_STATUS = <span class="hljs-number">207</span>  <span class="hljs-comment"># 多状态</span>
HTTP_208_ALREADY_REPORTED = <span class="hljs-number">208</span>  <span class="hljs-comment"># 已报告</span>
HTTP_226_IM_USED = <span class="hljs-number">226</span>  <span class="hljs-comment"># 正在使用</span>
HTTP_300_MULTIPLE_CHOICES = <span class="hljs-number">300</span>  <span class="hljs-comment"># 多选择</span>
HTTP_301_MOVED_PERMANENTLY = <span class="hljs-number">301</span>  <span class="hljs-comment"># 永久重定向</span>
HTTP_302_FOUND = <span class="hljs-number">302</span>  <span class="hljs-comment"># 临时重定向</span>
HTTP_303_SEE_OTHER = <span class="hljs-number">303</span>  <span class="hljs-comment"># 分配新地址</span>
HTTP_304_NOT_MODIFIED = <span class="hljs-number">304</span>  <span class="hljs-comment"># </span>
HTTP_305_USE_PROXY = <span class="hljs-number">305</span>  <span class="hljs-comment"># </span>
HTTP_306_RESERVED = <span class="hljs-number">306</span>  <span class="hljs-comment"># </span>
HTTP_307_TEMPORARY_REDIRECT = <span class="hljs-number">307</span>  <span class="hljs-comment"># 临时重定向2</span>
HTTP_308_PERMANENT_REDIRECT = <span class="hljs-number">308</span>  <span class="hljs-comment"># </span>
HTTP_400_BAD_REQUEST = <span class="hljs-number">400</span>  <span class="hljs-comment"># 语法错误</span>
HTTP_401_UNAUTHORIZED = <span class="hljs-number">401</span>  <span class="hljs-comment"># 未认证</span>
HTTP_402_PAYMENT_REQUIRED = <span class="hljs-number">402</span>  <span class="hljs-comment"># </span>
HTTP_403_FORBIDDEN = <span class="hljs-number">403</span>  <span class="hljs-comment"># 无权限</span>
HTTP_404_NOT_FOUND = <span class="hljs-number">404</span>  <span class="hljs-comment"># 未找到</span>
HTTP_405_METHOD_NOT_ALLOWED = <span class="hljs-number">405</span>  <span class="hljs-comment"># 方法不允许</span>
HTTP_406_NOT_ACCEPTABLE = <span class="hljs-number">406</span>  <span class="hljs-comment"># </span>
HTTP_407_PROXY_AUTHENTICATION_REQUIRED = <span class="hljs-number">407</span>  <span class="hljs-comment"># </span>
HTTP_408_REQUEST_TIMEOUT = <span class="hljs-number">408</span>  <span class="hljs-comment"># </span>
HTTP_409_CONFLICT = <span class="hljs-number">409</span>  <span class="hljs-comment"># </span>
HTTP_410_GONE = <span class="hljs-number">410</span>  <span class="hljs-comment"># </span>
HTTP_411_LENGTH_REQUIRED = <span class="hljs-number">411</span>  <span class="hljs-comment"># </span>
HTTP_412_PRECONDITION_FAILED = <span class="hljs-number">412</span>  <span class="hljs-comment"># </span>
HTTP_413_REQUEST_ENTITY_TOO_LARGE = <span class="hljs-number">413</span>  <span class="hljs-comment"># </span>
HTTP_414_REQUEST_URI_TOO_LONG = <span class="hljs-number">414</span>  <span class="hljs-comment"># </span>
HTTP_415_UNSUPPORTED_MEDIA_TYPE = <span class="hljs-number">415</span>  <span class="hljs-comment"># </span>
HTTP_416_REQUESTED_RANGE_NOT_SATISFIABLE = <span class="hljs-number">416</span>  <span class="hljs-comment"># </span>
HTTP_417_EXPECTATION_FAILED = <span class="hljs-number">417</span>  <span class="hljs-comment"># </span>
HTTP_418_IM_A_TEAPOT = <span class="hljs-number">418</span>  <span class="hljs-comment"># </span>
HTTP_422_UNPROCESSABLE_ENTITY = <span class="hljs-number">422</span>  <span class="hljs-comment"># </span>
HTTP_423_LOCKED = <span class="hljs-number">423</span>  <span class="hljs-comment"># </span>
HTTP_424_FAILED_DEPENDENCY = <span class="hljs-number">424</span>  <span class="hljs-comment"># </span>
HTTP_426_UPGRADE_REQUIRED = <span class="hljs-number">426</span>  <span class="hljs-comment"># </span>
HTTP_428_PRECONDITION_REQUIRED = <span class="hljs-number">428</span>  <span class="hljs-comment"># </span>
HTTP_429_TOO_MANY_REQUESTS = <span class="hljs-number">429</span>  <span class="hljs-comment">#   # </span>
HTTP_431_REQUEST_HEADER_FIELDS_TOO_LARGE = <span class="hljs-number">431</span>  <span class="hljs-comment"># </span>
HTTP_451_UNAVAILABLE_FOR_LEGAL_REASONS = <span class="hljs-number">451</span>  <span class="hljs-comment"># </span>
HTTP_500_INTERNAL_SERVER_ERROR = <span class="hljs-number">500</span>  <span class="hljs-comment"># 服务器错误</span>
HTTP_501_NOT_IMPLEMENTED = <span class="hljs-number">501</span>  <span class="hljs-comment"># </span>
HTTP_502_BAD_GATEWAY = <span class="hljs-number">502</span>  <span class="hljs-comment"># </span>
HTTP_503_SERVICE_UNAVAILABLE = <span class="hljs-number">503</span>  <span class="hljs-comment"># </span>
HTTP_504_GATEWAY_TIMEOUT = <span class="hljs-number">504</span>  <span class="hljs-comment"># </span>
HTTP_505_HTTP_VERSION_NOT_SUPPORTED = <span class="hljs-number">505</span>  <span class="hljs-comment"># </span>
HTTP_506_VARIANT_ALSO_NEGOTIATES = <span class="hljs-number">506</span>  <span class="hljs-comment"># </span>
HTTP_507_INSUFFICIENT_STORAGE = <span class="hljs-number">507</span>  <span class="hljs-comment"># </span>
HTTP_508_LOOP_DETECTED = <span class="hljs-number">508</span>  <span class="hljs-comment"># </span>
HTTP_509_BANDWIDTH_LIMIT_EXCEEDED = <span class="hljs-number">509</span>  <span class="hljs-comment"># </span>
HTTP_510_NOT_EXTENDED = <span class="hljs-number">510</span>  <span class="hljs-comment"># </span>
HTTP_511_NETWORK_AUTHENTICATION_REQUIRED = <span class="hljs-number">511</span>  <span class="hljs-comment"># </span></code></pre>

<h2 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h2><ul>
<li>需要安装 elasticsearch2.4.1并启动</li>
<li>windows：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/hualess/p/11540477.html">https://www.cnblogs.com/hualess/p/11540477.html</a></li>
<li>中文分词：elasticsearch-ik</li>
</ul>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><pre><code class="hljs sh"><span class="hljs-comment"># 注意版本需相对应</span>
pip install drf-haystack==1.8.10
pip install elasticsearch==2.4.1</code></pre>

<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><pre><code class="hljs python"><span class="hljs-comment">## settings.py</span>

INSTALLED_APPS = 
[
	...
	<span class="hljs-string">&#x27;rest_framework&#x27;</span>
	<span class="hljs-string">&#x27;haystack&#x27;</span>, 
]

<span class="hljs-comment"># Haystack</span>
HAYSTACK_CONNECTIONS = &#123;
    <span class="hljs-string">&#x27;default&#x27;</span>: &#123;
        <span class="hljs-string">&#x27;ENGINE&#x27;</span>: <span class="hljs-string">&#x27;haystack.backends.elasticsearch_backend.ElasticsearchSearchEngine&#x27;</span>,
        <span class="hljs-string">&#x27;URL&#x27;</span>: <span class="hljs-string">&#x27;http://127.0.0.1:9200/&#x27;</span>,  <span class="hljs-comment"># 此处为elasticsearch运行的服务器ip地址，端口号固定为9200</span>
        <span class="hljs-string">&#x27;INDEX_NAME&#x27;</span>: <span class="hljs-string">&#x27;fresh&#x27;</span>,  <span class="hljs-comment"># 指定elasticsearch建立的索引库的名称</span>
    &#125;,
&#125;
<span class="hljs-comment"># 当添加、修改、删除数据时，自动生成索引</span>
HAYSTACK_SIGNAL_PROCESSOR = <span class="hljs-string">&#x27;haystack.signals.RealtimeSignalProcessor&#x27;</span>
<span class="hljs-comment"># 指定搜索结果每页的条数</span>
<span class="hljs-comment"># HAYSTACK_SEARCH_RESULTS_PER_PAGE = 1</span></code></pre>

<h4 id="创建索引类"><a href="#创建索引类" class="headerlink" title="创建索引类"></a>创建索引类</h4><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> models 
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Es</span>(<span class="hljs-params">models.Model</span>):</span> 
    name=models.CharField(max_length=<span class="hljs-number">32</span>)
    desc=models.CharField(max_length=<span class="hljs-number">32</span>)</code></pre>

<h4 id="同目录app下创建search-indexes-py"><a href="#同目录app下创建search-indexes-py" class="headerlink" title="同目录app下创建search_indexes.py"></a>同目录app下创建search_indexes.py</h4><pre><code class="hljs python"><span class="hljs-keyword">from</span> haystack <span class="hljs-keyword">import</span> indexes
<span class="hljs-keyword">from</span> apps.product.models <span class="hljs-keyword">import</span> ProductInfo


<span class="hljs-comment"># 索引模型类的名称必须是 模型类名称 + Index</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProductInfoIndex</span>(<span class="hljs-params">indexes.SearchIndex, indexes.Indexable</span>):</span>
    <span class="hljs-comment"># text表示被查询的字段，用户搜索的是这些字段的值，具体被索引的字段写在另一个文件里</span>
    text = indexes.CharField(document=<span class="hljs-literal">True</span>, use_template=<span class="hljs-literal">True</span>)
    
    <span class="hljs-comment"># 保存在索引库中的字段</span>
    <span class="hljs-built_in">id</span> = indexes.IntegerField(model_attr=<span class="hljs-string">&#x27;id&#x27;</span>)
    name = indexes.CharField(model_attr=<span class="hljs-string">&#x27;name&#x27;</span>)
    

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_model</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> ProductInfo

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index_queryset</span>(<span class="hljs-params">self, using=<span class="hljs-literal">None</span></span>):</span>
        <span class="hljs-keyword">return</span> self.get_model().objects.<span class="hljs-built_in">all</span>()
</code></pre>

<h4 id="创建模板文件"><a href="#创建模板文件" class="headerlink" title="创建模板文件"></a>创建模板文件</h4><ul>
<li>创建 templates/search/indexes/app/es_text.txt</li>
<li>名字要对应</li>
</ul>
<pre><code class="hljs handlebars"><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">object.name</span> &#125;&#125;</span><span class="xml"> </span>
<span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">object.desc</span> &#125;&#125;</span></code></pre>

<h4 id="手动更新索引"><a href="#手动更新索引" class="headerlink" title="手动更新索引"></a>手动更新索引</h4><ul>
<li>数据库有多少条数据，全部会被同步到es中</li>
</ul>
<pre><code class="hljs sh"><span class="hljs-comment"># 首次重建</span>
python manage.py rebuild_index
<span class="hljs-comment"># 更新</span>
python manage.py update_index</code></pre>

<h4 id="创建haystack序列化器"><a href="#创建haystack序列化器" class="headerlink" title="创建haystack序列化器"></a>创建haystack序列化器</h4><pre><code class="hljs python"><span class="hljs-keyword">from</span> drf_haystack.serializers 
<span class="hljs-keyword">import</span> HaystackSerializer 
<span class="hljs-keyword">from</span> rest_framework.serializers 
<span class="hljs-keyword">import</span> ModelSerializer <span class="hljs-keyword">from</span> app 
<span class="hljs-keyword">import</span> models 
<span class="hljs-keyword">from</span> app.search_indexes <span class="hljs-keyword">import</span> EsIndex 
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EsSerializer</span>(<span class="hljs-params">ModelSerializer</span>):</span> 
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span> 
        model=models.Es 
        fields=<span class="hljs-string">&#x27;__all__&#x27;</span> 
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EsIndexSerializer</span>(<span class="hljs-params">HaystackSerializer</span>):</span> 
     <span class="hljs-built_in">object</span> = EsSerializer(read_only=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 只读,不可以进行反序列化</span>
     <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span> 
        index_classes = [EsIndex]  <span class="hljs-comment"># 索引类的名称</span>
        fields = (<span class="hljs-string">&#x27;text&#x27;</span>, <span class="hljs-string">&#x27;object&#x27;</span>)  <span class="hljs-comment"># text：由索引类返回，固定名称；object：由序列化类返回</span></code></pre>

<h4 id="类试图调用"><a href="#类试图调用" class="headerlink" title="类试图调用"></a>类试图调用</h4><pre><code class="hljs angelscript"><span class="hljs-keyword">from</span> drf_haystack.viewsets 
<span class="hljs-keyword">import</span> HaystackViewSet 
<span class="hljs-keyword">from</span> app.models <span class="hljs-keyword">import</span> Book 
<span class="hljs-keyword">from</span> app.serializers <span class="hljs-keyword">import</span> EsIndexSerializer 

<span class="hljs-keyword">class</span> <span class="hljs-symbol">EsSearchView</span>(<span class="hljs-symbol">HaystackViewSet</span>): 
    <span class="hljs-symbol">index_models</span> = [<span class="hljs-symbol">Es</span>] 
    <span class="hljs-symbol">serializer_class</span> = <span class="hljs-symbol">EsIndexSerializer</span></code></pre>

<h4 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h4><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.conf.urls 
<span class="hljs-keyword">import</span> url <span class="hljs-keyword">from</span> django.contrib 
<span class="hljs-keyword">import</span> admin 
<span class="hljs-keyword">from</span> rest_framework <span class="hljs-keyword">import</span> routers 

<span class="hljs-keyword">from</span> app.views <span class="hljs-keyword">import</span> EsSearchView 
    router = routers.DefaultRouter() 
    router.register(<span class="hljs-string">&quot;book/search&quot;</span>, EsSearchView, base_name=<span class="hljs-string">&quot;book-search&quot;</span>) 
    urlpatterns = [ url(<span class="hljs-string">r&#x27;^admin/&#x27;</span>, admin.site.urls), ] 
    urlpatterns += router.urls</code></pre>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8000</span>/?text=测试</code></pre>



<h2 id="Celery"><a href="#Celery" class="headerlink" title="Celery"></a>Celery</h2><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> django-celery</code></pre>

<ul>
<li>proj/celery.py</li>
</ul>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> os

<span class="hljs-keyword">from</span> celery <span class="hljs-keyword">import</span> Celery

<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta

<span class="hljs-comment"># 设置默认的Django设置模块</span>
os.environ.setdefault(<span class="hljs-string">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class="hljs-string">&#x27;alarmManagerBackend.settings&#x27;</span>)

app = Celery(<span class="hljs-string">&#x27;alarmManagerBackend&#x27;</span>)

<span class="hljs-comment"># 在这里使用字符串意味着worker不需要序列化</span>
<span class="hljs-comment"># 子进程的配置对象</span>
<span class="hljs-comment"># - namespace表示所有芹菜相关的配置键，应该有一个“CELERY_”前缀。</span>
app.config_from_object(<span class="hljs-string">&#x27;django.conf:settings&#x27;</span>, namespace=<span class="hljs-string">&#x27;CELERY&#x27;</span>)

<span class="hljs-comment"># 从所有注册的Django应用中加载任务模块。</span>
app.autodiscover_tasks()

<span class="hljs-comment"># 定时任务</span>
app.conf.beat_schedule = &#123;
    <span class="hljs-string">&#x27;skywalking_self_recover&#x27;</span>: &#123;
        <span class="hljs-string">&#x27;task&#x27;</span>: <span class="hljs-string">&#x27;skywalking.tasks.skywalking_self_recover&#x27;</span>,
        <span class="hljs-comment"># &#x27;schedule&#x27;: timedelta(minutes=2)</span>
        <span class="hljs-string">&#x27;schedule&#x27;</span>: <span class="hljs-number">3</span>
    &#125;,
&#125;</code></pre>

<p>apps/xxx/tasks.py</p>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> celery <span class="hljs-keyword">import</span> shared_task

<span class="hljs-meta">@shared_task</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">task_demo</span>():</span>
    print(<span class="hljs-number">2</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span></code></pre>

<h4 id="启动命令"><a href="#启动命令" class="headerlink" title="启动命令"></a>启动命令</h4><pre><code class="hljs sh"><span class="hljs-comment">## windows</span>
celery -A proj worker -l INFO --pool=solo -P eventlet
celery -A proj beat -l info

--logfile=E:\GCloud\alarmmanagerbackend\logs\celery.log
celery -A alarmManagerBackend beat -l info --

<span class="hljs-comment"># linux启动，不要用root用户</span>
celery multi start -A proj worker -l info --logfile=celery.log --pidfile=celery.pid
celery multi restart -A proj worker -l info --logfile=celery.log --pidfile=celery.pid
celery multi stop -A proj worker -l info --logfile=celery.log --pidfile=celery.pid

<span class="hljs-comment"># celery进程全杀</span>
ps auxww | grep <span class="hljs-string">&#x27;celery&#x27;</span> | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | xargs <span class="hljs-built_in">kill</span> -9</code></pre>



<h3 id="发邮件"><a href="#发邮件" class="headerlink" title="发邮件"></a>发邮件</h3><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><pre><code class="hljs python"><span class="hljs-comment">## settings.py</span>

<span class="hljs-comment"># 配置邮件服务器</span>
<span class="hljs-comment"># EMAIL_BACKEND = &#x27;django.core.mail.backends.smtp.EmailBackend&#x27;</span>
EMAIL_HOST = <span class="hljs-string">&#x27;smtp.163.com&#x27;</span>  <span class="hljs-comment"># 如果是 qq 改成 smtp.qq.com</span>
EMAIL_PORT = <span class="hljs-number">465</span>  <span class="hljs-comment"># 发邮件端口</span>
EMAIL_HOST_USER = <span class="hljs-string">&#x27;&#x27;</span>  <span class="hljs-comment"># 邮箱</span>
EMAIL_HOST_PASSWORD = <span class="hljs-string">&#x27;&#x27;</span>  <span class="hljs-comment"># 密码授权码</span>
EMAIL_FROM = EMAIL_HOST_USER  <span class="hljs-comment"># 发件人抬头</span>
<span class="hljs-comment"># EMAIL_USE_TLS = False  # 是否使用安全协议传输</span>
EMAIL_USE_SSL = <span class="hljs-literal">True</span></code></pre>

<p><strong>安装celery</strong></p>
<pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> celery</code></pre>

<p>项目下创建目录 celert_tasks</p>
<h4 id="创建celery异步任务"><a href="#创建celery异步任务" class="headerlink" title="创建celery异步任务"></a>创建celery异步任务</h4><ul>
<li>celery_tasks/main.py</li>
</ul>
<pre><code class="hljs python"><span class="hljs-keyword">import</span> os

<span class="hljs-keyword">from</span> celery <span class="hljs-keyword">import</span> Celery

<span class="hljs-comment"># 把celery和django进行组合，必须让celery能识别和加载django的配置文件以及django的类库</span>
os.environ.setdefault(<span class="hljs-string">&quot;DJANGO_SETTINGS_MODULE&quot;</span>, <span class="hljs-string">&quot;fresh.settings&quot;</span>)

<span class="hljs-comment"># 对django框架初始化</span>
<span class="hljs-keyword">import</span> django

django.setup()

<span class="hljs-comment"># 创建Celery实例 生产者</span>
app = Celery(<span class="hljs-string">&#x27;fresh&#x27;</span>)

<span class="hljs-comment"># 加载配置</span>
app.config_from_object(<span class="hljs-string">&#x27;celery_tasks.config&#x27;</span>)

<span class="hljs-comment"># 注册任务，多任务写多个</span>
app.autodiscover_tasks([<span class="hljs-string">&#x27;celery_tasks.email&#x27;</span>])</code></pre>

<p>celery_tasks/config.py</p>
<pre><code class="hljs python"><span class="hljs-comment"># Celery配置文件</span>
<span class="hljs-comment"># 指定中间人、消息队列、任务队列、容器，使用redis</span>
broker_url = <span class="hljs-string">&#x27;redis://127.0.0.1/3&#x27;</span>

<span class="hljs-comment"># 结果队列的链接地址</span>
celery_result_backend = <span class="hljs-string">&#x27;redis://127.0.0.1:6379/14&#x27;</span></code></pre>

<p>celery_tasks/email/tasks.py</p>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> celery <span class="hljs-keyword">import</span> Task
<span class="hljs-keyword">from</span> django.core.mail <span class="hljs-keyword">import</span> send_mail
<span class="hljs-keyword">from</span> django.conf <span class="hljs-keyword">import</span> settings

<span class="hljs-keyword">from</span> celery_tasks.main <span class="hljs-keyword">import</span> celery_app


<span class="hljs-comment"># 监听整个任务的钩子，有时任务会失败</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Mytask</span>(<span class="hljs-params">Task</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_success</span>(<span class="hljs-params">self, retval, task_id, args, kwargs</span>):</span>
        print(<span class="hljs-string">&#x27;task success！&#x27;</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>(Mytask, self).on_success(retval, task_id, args, kwargs)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_failure</span>(<span class="hljs-params">self, exc, task_id, args, kwargs, einfo</span>):</span>
        print(<span class="hljs-string">&#x27;task failed&#x27;</span>)
        <span class="hljs-comment"># 可以记录到程序中或者任务队列中,让celery尝试重新执行</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>(Mytask, self).on_failure(exc, task_id, args, kwargs, einfo)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">after_return</span>(<span class="hljs-params">self, status, retval, task_id, args, kwargs, einfo</span>):</span>
        print(<span class="hljs-string">&#x27;this is after return&#x27;</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>(Mytask, self).after_return(status, retval, task_id, args, kwargs, einfo)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_retry</span>(<span class="hljs-params">self, exc, task_id, args, kwargs, einfo</span>):</span>
        print(<span class="hljs-string">&#x27;this is retry&#x27;</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>(Mytask, self).on_retry(exc, task_id, args, kwargs, einfo)


<span class="hljs-meta">@celery_app.task(name=&#x27;send_verify_email&#x27;, base=Mytask)  # name：起别名；base：为监听类</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">send_verify_email</span>(<span class="hljs-params">to_email, verify_url</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;定义发送邮件的任务&quot;&quot;&quot;</span>
    <span class="hljs-comment"># send_mail(&#x27;标题&#x27;,&#x27;普通邮件的正文&#x27;,&#x27;发件人&#x27;,&#x27;收件人列表&#x27;,&#x27;富文本邮件正文&#x27;)</span>
    project_name = <span class="hljs-string">&#x27;test&#x27;</span>
    subject = project_name + <span class="hljs-string">&#x27;邮箱验证&#x27;</span>
    <span class="hljs-comment"># message = &#x27;普通文本&#x27;</span>
    <span class="hljs-comment"># html_message是发送带html样式信息</span>
    html_message = <span class="hljs-string">&#x27;&lt;p&gt;尊敬的用户您好！&lt;/p&gt;&#x27;</span> \
                   <span class="hljs-string">&#x27;&lt;p&gt;感谢您使用%s。&lt;/p&gt;&#x27;</span> \
                   <span class="hljs-string">&#x27;&lt;p&gt;您的邮箱为：%s 。请点击此链接激活您的邮箱：&lt;/p&gt;&#x27;</span> \
                   <span class="hljs-string">&#x27;&lt;p&gt;&lt;a href=&quot;%s&quot;&gt;%s&lt;a&gt;&lt;/p&gt;&#x27;</span> % (project_name, to_email, verify_url, verify_url)
    send_mail(subject, <span class="hljs-string">&#x27;&#x27;</span>, settings.EMAIL_FROM, [to_email], html_message=html_message)</code></pre>

<h4 id="视图调用"><a href="#视图调用" class="headerlink" title="视图调用"></a>视图调用</h4><pre><code class="hljs python"><span class="hljs-keyword">from</span> celery_tasks.email.tasks <span class="hljs-keyword">import</span> send_verify_email

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmailView</span>(<span class="hljs-params">APIView</span>):</span>
	<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">post</span>(<span class="hljs-params">self, request</span>):</span>
        logger = logging.getLogger(<span class="hljs-string">&#x27;django&#x27;</span>)
        send_verify_email.delay(email, verify_url)
        <span class="hljs-keyword">return</span> JsonResponse(&#123;<span class="hljs-string">&#x27;code&#x27;</span>: <span class="hljs-number">0</span>, <span class="hljs-string">&#x27;message&#x27;</span>: <span class="hljs-string">&#x27;成功&#x27;</span>&#125;)</code></pre>

<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><pre><code class="hljs sh"><span class="hljs-comment"># windows测试启动</span>
celery -A alarmManagerBackend worker -l INFO --pool=solo
celery -A alarmManagerBackend beat -l info

celery -A alarmManagerBackend worker -l INFO --pool=solo --logfile=E:\GCloud\API\alarmmanagerbackend\logs\celery.log
celery -A alarmManagerBackend beat -l info --logfile=E:\GCloud\API\alarmmanagerbackend\logs\celery.log

celery -A alarmManagerBackend worker --pool=solo -l info -P eventlet
celery -A alarmManagerBackend beat -l info -P eventlet


<span class="hljs-comment"># linux启动，不要用root用户</span>
celery multi start -A celery_tasks.main worker -l info --logfile=celery.log --pidfile=celery.pid
celery multi restart -A celery_tasks.main worker -l info --logfile=celery.log --pidfile=celery.pid
celery multi stop -A celery_tasks.main worker -l info --logfile=celery.log --pidfile=celery.pid

<span class="hljs-comment"># celery进程全杀</span>
ps auxww | grep <span class="hljs-string">&#x27;celery&#x27;</span> | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> | xargs <span class="hljs-built_in">kill</span> -9</code></pre>



<h2 id="数据库读写分离"><a href="#数据库读写分离" class="headerlink" title="数据库读写分离"></a>数据库读写分离</h2><p>新建 db_router.py</p>
<pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MasterSlaveDBRouter</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;数据库主从读写分离路由&quot;&quot;&quot;</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">db_for_read</span>(<span class="hljs-params">self, model, **hints</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;读数据库&quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;slave&quot;</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">db_for_write</span>(<span class="hljs-params">self, model, **hints</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;写数据库&quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;default&quot;</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">allow_relation</span>(<span class="hljs-params">self, obj1, obj2, **hints</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;是否运行关联操作&quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span></code></pre>

<p>配置 setting.py</p>
<pre><code class="hljs python">DATABASE_ROUTERS = [<span class="hljs-string">&quot;app.db_router.MasterSlaveDBRouter&quot;</span>]</code></pre>

<h2 id="生成接口文档"><a href="#生成接口文档" class="headerlink" title="生成接口文档"></a>生成接口文档</h2><ul>
<li>环境说明<ul>
<li>python &gt;= 3.6.2</li>
<li>Jinja2 &lt;= 3.0.0</li>
</ul>
</li>
</ul>
<pre><code class="hljs sh">pip install coreapi
pip install djangorestframework</code></pre>

<p><strong>配置</strong></p>
<pre><code class="hljs python"><span class="hljs-comment">## setting.py</span>

INSTALLED_APPS = [
    ...
    <span class="hljs-string">&#x27;rest_framework&#x27;</span>
]

REST_FRAMEWORK = &#123;
    ...
	<span class="hljs-string">&#x27;DEFAULT_SCHEMA_CLASS&#x27;</span>: <span class="hljs-string">&#x27;rest_framework.schemas.AutoSchema&#x27;</span>,
&#125;</code></pre>

<h5 id="路由-1"><a href="#路由-1" class="headerlink" title="路由"></a>路由</h5><pre><code class="hljs python">urlpatterns = [
    path(<span class="hljs-string">&#x27;docs/&#x27;</span>, include_docs_urls(title=<span class="hljs-string">&#x27;接口文档&#x27;</span>)),
]</code></pre>

<h5 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h5><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8000</span>/docs</code></pre>



<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><h4 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h4><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.test <span class="hljs-keyword">import</span> TestCase

<span class="hljs-comment"># 需要测试的函数</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span>(<span class="hljs-params">a, b</span>):</span>
    <span class="hljs-keyword">return</span> a + b

<span class="hljs-comment"># 普通测试</span>
d = add(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>)
<span class="hljs-keyword">assert</span> d == <span class="hljs-number">4</span>  <span class="hljs-comment"># 验证结果是否相等</span>


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookTestCase</span>(<span class="hljs-params">TestCase</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;框架测试&quot;&quot;&quot;</span>
    
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUpClass</span>(<span class="hljs-params">cls</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;所有测试用例之前调用&quot;&quot;&quot;</span>
        <span class="hljs-keyword">pass</span>
    
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tearDownClass</span>(<span class="hljs-params">cls</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;所有测试用例之后调用&quot;&quot;&quot;</span>
        <span class="hljs-keyword">pass</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUp</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-string">&quot;&quot;&quot;前置准备，每个测试方法之前调用&quot;&quot;&quot;</span>
        <span class="hljs-keyword">pass</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tearDown</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-string">&quot;&quot;&quot;后置处理，每个测试方法之后调用&quot;&quot;&quot;</span>
        <span class="hljs-keyword">pass</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_1</span>(<span class="hljs-params">self</span>):</span> <span class="hljs-comment"># 测试函数必须以 test 开头</span>
        <span class="hljs-string">&quot;&quot;&quot;测试功能&quot;&quot;&quot;</span>
        c = add(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>)
        self.assertEqual(c, <span class="hljs-number">1</span>)  <span class="hljs-comment"># 验证结果是否相等</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_2</span>(<span class="hljs-params">self</span>):</span>
        c = add(<span class="hljs-number">-1</span>, - <span class="hljs-number">3</span>)
        self.assertEqual(c, <span class="hljs-number">-4</span>)
    
<span class="hljs-comment"># python manage.py test</span>
<span class="hljs-comment"># python manage.py test 模块名</span>
<span class="hljs-comment"># python manage.py test 模块名.tests.类名</span>
<span class="hljs-comment"># python manage.py test 模块名.tests.类名.函数名</span></code></pre>

<h4 id="模型测试"><a href="#模型测试" class="headerlink" title="模型测试"></a>模型测试</h4><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserTestCase</span>(<span class="hljs-params">TestCase</span>):</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUp</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-comment"># UserWechat.objects.create(openid=&#x27;aaa&#x27;)</span>
        <span class="hljs-keyword">pass</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_user_create</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;测试用户创建&quot;&quot;&quot;</span>
        User.objects.create(username=<span class="hljs-string">&#x27;aaa&#x27;</span>, gender=<span class="hljs-string">&#x27;a&#x27;</span>)
        res = User.objects.get(username=<span class="hljs-string">&#x27;aaa&#x27;</span>)
        self.assertEqual(res.username, <span class="hljs-string">&#x27;aaa&#x27;</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tearDown</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
        <span class="hljs-keyword">pass</span></code></pre>

<h4 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a>接口测试</h4><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserAPITestCase</span>(<span class="hljs-params">TestCase</span>):</span>
    
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_hello</span>(<span class="hljs-params">self</span>):</span>
        res = self.client.get(<span class="hljs-string">&#x27;/hello&#x27;</span>)
        self.assertEqual(res.status_code, <span class="hljs-number">200</span>)
        self.assertEqual(res.json().get(<span class="hljs-string">&#x27;code&#x27;</span>), <span class="hljs-number">0</span>)
        
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_login</span>(<span class="hljs-params">self</span>):</span>
        data = &#123;
            <span class="hljs-string">&quot;openid&quot;</span>: <span class="hljs-string">&quot;acx&quot;</span>,
            <span class="hljs-string">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;LP&quot;</span>,
            <span class="hljs-string">&quot;gender&quot;</span>: <span class="hljs-number">0</span>
        &#125;
        res = self.client.post(<span class="hljs-string">&#x27;/login&#x27;</span>, data=data, content_type=<span class="hljs-string">&#x27;application/json&#x27;</span>)
        self.assertEqual(res.status_code, <span class="hljs-number">200</span>)</code></pre>

<h5 id="Session-2"><a href="#Session-2" class="headerlink" title="Session"></a>Session</h5><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> django.test <span class="hljs-keyword">import</span> TestCase

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserAPITestCase</span>(<span class="hljs-params">TestCase</span>):</span>

<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUpClass</span>(<span class="hljs-params">cls</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;所有测试用例之前调用&quot;&quot;&quot;</span>
        data = &#123;
            <span class="hljs-string">&quot;openid&quot;</span>: <span class="hljs-string">&quot;aaaa&quot;</span>,
            <span class="hljs-string">&quot;nickname&quot;</span>: <span class="hljs-string">&quot;LP&quot;</span>,
            <span class="hljs-string">&quot;gender&quot;</span>: <span class="hljs-number">0</span>
        &#125;
        cls.s = requests
        res = cls.s.post(<span class="hljs-string">&#x27;http://127.0.0.1:8000/fresh/api/user/login&#x27;</span>, json=data)
        print(<span class="hljs-string">&#x27;登录结果&#x27;</span>, res.json())
        <span class="hljs-keyword">pass</span>

<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tearDownClass</span>(<span class="hljs-params">cls</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;所有测试用例之后调用&quot;&quot;&quot;</span>
        <span class="hljs-keyword">pass</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_logout</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-string">&quot;&quot;&quot;需要session校验&quot;&quot;&quot;</span>
        res = self.s.delete(<span class="hljs-string">&#x27;http://127.0.0.1:8000/fresh/api/user/logout&#x27;</span>)
        self.assertEqual(res.status_code, <span class="hljs-number">200</span>)</code></pre>

<h2 id="XAdmin"><a href="#XAdmin" class="headerlink" title="XAdmin"></a>XAdmin</h2><h2 id="Admin-simpleui"><a href="#Admin-simpleui" class="headerlink" title="Admin-simpleui"></a>Admin-simpleui</h2><p><a target="_blank" rel="noopener" href="https://simpleui.72wo.com/docs/simpleui/">https://simpleui.72wo.com/docs/simpleui/</a></p>
<h2 id="Admin"><a href="#Admin" class="headerlink" title="Admin"></a>Admin</h2><h3 id="修改admin标题"><a href="#修改admin标题" class="headerlink" title="修改admin标题"></a>修改admin标题</h3><pre><code class="hljs python"><span class="hljs-keyword">from</span> django.contrib <span class="hljs-keyword">import</span> admin

admin.site.site_title = <span class="hljs-string">&#x27;管理后台&#x27;</span>
admin.site.site_header = <span class="hljs-string">&quot;xx管理后台&quot;</span></code></pre>

<h3 id="导入导出"><a href="#导入导出" class="headerlink" title="导入导出"></a>导入导出</h3><pre><code class="hljs sh">pip install django-import-export</code></pre>

<pre><code class="hljs python"><span class="hljs-comment">## settings.py</span>
INSTALLED_APPS = [
	...
    <span class="hljs-string">&#x27;import_export&#x27;</span>,
    ...
]

<span class="hljs-comment">## admin.py</span>
<span class="hljs-keyword">from</span> django.contrib <span class="hljs-keyword">import</span> admin
<span class="hljs-keyword">from</span> import_export <span class="hljs-keyword">import</span> resources
<span class="hljs-keyword">from</span> import_export.admin <span class="hljs-keyword">import</span> ImportExportActionModelAdmin
<span class="hljs-keyword">from</span> .models <span class="hljs-keyword">import</span> Book

<span class="hljs-comment"># 创建进出口资源</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookResource</span>(<span class="hljs-params">resources.ModelResource</span>):</span>
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        model = Book
        fields = (<span class="hljs-string">&#x27;id&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;price&#x27;</span>)  <span class="hljs-comment"># 导出字段</span>
        <span class="hljs-comment"># exclude = (&#x27;imported&#x27;, )  # 导出排除字段</span>
        
<span class="hljs-meta">@admin.register(Book)</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookAdmin</span>(<span class="hljs-params">ImportExportActionModelAdmin</span>):</span>
    resource_class = BookResource

    list_display = (<span class="hljs-string">&#x27;id&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;price&#x27;</span>, <span class="hljs-string">&#x27;create_time&#x27;</span>)</code></pre>



<h2 id="项目部署"><a href="#项目部署" class="headerlink" title="项目部署"></a>项目部署</h2><p>环境</p>
<pre><code class="hljs angelscript">nginx1<span class="hljs-number">.20</span><span class="hljs-number">.0</span>
mysql5<span class="hljs-number">.7</span>
redis5<span class="hljs-number">.0</span><span class="hljs-number">.3</span>
django3<span class="hljs-number">.2</span><span class="hljs-number">.0</span></code></pre>

<p>创建python虚拟环境</p>
<pre><code class="hljs sh">conda create -n fresh python==2.6.2

<span class="hljs-comment"># 安装pip环境</span>
pip install -r requirements.txt
<span class="hljs-comment"># 安装uwsgi</span>
pip install uwsgi</code></pre>

<ul>
<li>pip mysqlclient报错</li>
</ul>
<pre><code class="hljs cmake">yum <span class="hljs-keyword">install</span> mysql-devel</code></pre>

<ul>
<li>pip uwsgi报错</li>
<li>参考：<a target="_blank" rel="noopener" href="https://anaconda.org/conda-forge/uwsgi">乌斯吉 * Anaconda.org</a></li>
</ul>
<pre><code class="hljs awk">conda install -c conda-forge<span class="hljs-regexp">/label/g</span>cc7 uwsgi</code></pre>

<h4 id="项目目录下创建-uwsgi-ini-文件"><a href="#项目目录下创建-uwsgi-ini-文件" class="headerlink" title="项目目录下创建 uwsgi.ini 文件"></a>项目目录下创建 uwsgi.ini 文件</h4><pre><code class="hljs ini"><span class="hljs-section">[uwsgi]</span>
<span class="hljs-comment"># 项目目录</span>
<span class="hljs-attr">chdir</span>=/root/project/fresh
<span class="hljs-comment"># 设置日志存储</span>
<span class="hljs-attr">daemonize</span>=/root/project/fresh/uwsgi.log
<span class="hljs-comment"># 你项目使用的虚拟环境的根目录 绝对地址</span>
<span class="hljs-attr">virtualenv</span> = /root/miniconda3/envs/fresh
<span class="hljs-comment"># 指定socket，真实端口</span>
<span class="hljs-attr">socket</span>=:<span class="hljs-number">8001</span>
<span class="hljs-comment"># 指定pid文件</span>
<span class="hljs-attr">pidfile</span>=/root/project/fresh/uwsgi.pid
<span class="hljs-comment"># 指定项目的wsgi模块</span>
<span class="hljs-attr">module</span>=fresh.wsgi
<span class="hljs-comment"># 启用主进程</span>
<span class="hljs-attr">master</span>=<span class="hljs-literal">true</span>
<span class="hljs-comment"># 进程个数</span>
<span class="hljs-attr">workers</span>=<span class="hljs-number">3</span>
<span class="hljs-comment"># 在每个worker而不是master中加载应用</span>
<span class="hljs-attr">lazy-apps</span>=<span class="hljs-literal">true</span>
<span class="hljs-comment"># 每个进程最大的请求数</span>
<span class="hljs-attr">max-request</span> = <span class="hljs-number">1000</span>
<span class="hljs-comment"># 启动uwsgi的用户名和用户组</span>
<span class="hljs-attr">uid</span>=root
<span class="hljs-attr">gid</span>=root
<span class="hljs-comment"># 自动移除unix Socket和pid文件当服务停止的时候</span>
<span class="hljs-attr">vacuum</span>=<span class="hljs-literal">true</span>
<span class="hljs-comment"># 启用线程</span>
<span class="hljs-attr">enable-threads</span>=<span class="hljs-literal">true</span>
<span class="hljs-comment"># 设置自中断时间</span>
<span class="hljs-attr">harakiri</span>=<span class="hljs-number">30</span>
<span class="hljs-comment"># 设置缓冲</span>
<span class="hljs-attr">post-buffering</span>=<span class="hljs-number">4096</span>
<span class="hljs-comment">#设置在平滑的重启（直到接收到的请求处理完才重启）一个工作子进程中，等待这个工作结束的最长秒数。这个配置会使在平滑地重启工作子进程中，如果工作进程结束时间超过了8秒就会被强行结束（忽略之前已经接收到的请求而直接结束）</span>
<span class="hljs-attr">reload-mercy</span> = <span class="hljs-number">8</span></code></pre>

<h4 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h4><pre><code class="hljs sh">upstream fresh &#123;
    server 127.0.0.1:8001;
&#125;

server &#123;
    listen 80;
    server_name www.smilelp.top;

    location = /ok &#123;
        default_type application/json;
        <span class="hljs-built_in">return</span> 200 <span class="hljs-string">&#x27;&#123;&quot;msg&quot;:&quot;www.smilelp.top&quot;&#125;&#x27;</span>;
    &#125;

    location / &#123;
        include uwsgi_params;
        uwsgi_pass fresh;
        uwsgi_read_timeout 15;
    &#125;

    location /static &#123;
        <span class="hljs-built_in">alias</span> /root/project/fresh/static;
    &#125;

&#125;</code></pre>

<p>uwsgi启动 django项目</p>
<pre><code class="hljs sh"><span class="hljs-comment"># 启动</span>
uwsgi --ini uwsgi.ini
<span class="hljs-comment"># 关闭</span>
uwsgi --stop uwsgi.pid
<span class="hljs-comment"># 重载nginx</span>
systemcal reload nginx</code></pre>



<h3 id="Docker部署"><a href="#Docker部署" class="headerlink" title="Docker部署"></a>Docker部署</h3><ul>
<li>docker+nginx+uwsgi+django+python+mysql+redis</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/aafeiyang/article/details/100152373/">https://blog.csdn.net/aafeiyang/article/details/100152373/</a></p>
<p>Dokerfile</p>
<pre><code class="hljs awk">FROM ubuntu:<span class="hljs-number">16.04</span>
FROM python:<span class="hljs-number">3.6</span>

ENV http_proxy=http:<span class="hljs-regexp">//</span>xxx.xxx.xxx.xxx:<span class="hljs-number">3128</span>
ENV https_proxy=http:<span class="hljs-regexp">//</span>xxx.xxx.xxx.xxx:<span class="hljs-number">3128</span>
 
RUN apt-get -y update &amp;&amp; \
    apt-get -y upgrade &amp;&amp; \
    apt-get install -y \
    vim \
	git \
	python3-dev \
	python3-setuptools \
	python3-pip \
	nginx \
	supervisor \
        nodejs \
        npm \
        default-libmysqlclient-dev &amp;&amp; \
        pip3 install --upgrade -i https:<span class="hljs-regexp">//</span>pypi.doubanio.com<span class="hljs-regexp">/simple/</span> pip setuptools &amp;&amp; \
  	rm -rf <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/apt/</span>lists/*
 
RUN pip3 install -i https:<span class="hljs-regexp">//</span>pypi.doubanio.com<span class="hljs-regexp">/simple/</span> uwsgi
 
COPY requirements.txt <span class="hljs-regexp">/data/</span>Project/
RUN pip3 install -i https:<span class="hljs-regexp">//</span>pypi.doubanio.com<span class="hljs-regexp">/simple/</span> -r <span class="hljs-regexp">/data/</span>Project/requirements.txt
 
COPY .<span class="hljs-regexp">/build/</span>nginx<span class="hljs-regexp">/nginx.conf /</span>etc<span class="hljs-regexp">/nginx/</span>nginx.conf
RUN echo <span class="hljs-string">&quot;daemon off;&quot;</span> &gt;&gt; <span class="hljs-regexp">/etc/</span>nginx/nginx.conf
COPY .<span class="hljs-regexp">/build/</span>nginx<span class="hljs-regexp">/conf.d  /</span>etc<span class="hljs-regexp">/nginx/</span>conf.d
 
ENV PYTHONIOENCODING=utf-<span class="hljs-number">8</span>
 
EXPOSE <span class="hljs-number">9990</span> <span class="hljs-number">9999</span></code></pre>



<p><strong>通过docker-compose.yml 将容器运行起来</strong></p>
<pre><code class="hljs yml"><span class="hljs-attr">nginx:</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">nginx</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">registry.cn-shenzhen.aliyuncs.com/beni/nginx:latest</span>
    <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-number">80</span><span class="hljs-string">:80</span>
    <span class="hljs-attr">volumes:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">C:/data/django/nginx:/etc/nginx/conf.d</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">C:/data/django/www:/data/django/www</span>
    <span class="hljs-attr">links:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">django:django</span>
 
<span class="hljs-attr">django:</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">django</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">registry.cn-shenzhen.aliyuncs.com/beni/django:latest</span>
    <span class="hljs-attr">volumes:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">C:/data/django/www:/data/django/www</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">uwsgi</span> <span class="hljs-string">--ini</span> <span class="hljs-string">/data/django/www/mblog/uwsgi.ini</span></code></pre>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Python/">Python</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Python-Django/">Python,Django</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处。</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/12/14/python/Python/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Python</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/10/25/cloud/install/Kubernetes%20Install/">
                        <span class="hidden-mobile">Kubernetes Install</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://1ch0.github.io/" target="_blank" rel="nofollow noopener"><span>1ch0</span></a> <i class="iconfont icon-love"></i> <a href="https://1ch0.github.io/" target="_blank" rel="nofollow noopener"><span>Go</span></a> <div> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "Python&nbsp;",
      ],
      cursorChar: ".",
      typeSpeed: 100,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>















</body>
</html>
